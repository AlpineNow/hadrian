

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>titus.genpy &mdash; Titus 0.7.1 documentation</title>
    
    <link rel="stylesheet" href="../../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../static/jquery.js"></script>
    <script type="text/javascript" src="../../static/underscore.js"></script>
    <script type="text/javascript" src="../../static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Titus 0.7.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Titus 0.7.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for titus.genpy</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>

<span class="c"># Copyright (C) 2014  Open Data (&quot;Open Data&quot; refers to</span>
<span class="c"># one or more of the following companies: Open Data Partners LLC,</span>
<span class="c"># Open Data Research LLC, or Open Data Capital LLC.)</span>
<span class="c"># </span>
<span class="c"># This file is part of Hadrian.</span>
<span class="c"># </span>
<span class="c"># Licensed under the Hadrian Personal Use and Evaluation License (PUEL);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c"># </span>
<span class="c">#     http://raw.githubusercontent.com/opendatagroup/hadrian/master/LICENSE</span>
<span class="c"># </span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="kn">from</span> <span class="nn">avro.datafile</span> <span class="kn">import</span> <span class="n">DataFileReader</span><span class="p">,</span> <span class="n">DataFileWriter</span>
<span class="kn">from</span> <span class="nn">avro.io</span> <span class="kn">import</span> <span class="n">DatumReader</span><span class="p">,</span> <span class="n">DatumWriter</span>

<span class="kn">from</span> <span class="nn">titus.errors</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">titus.pfaast</span>
<span class="kn">import</span> <span class="nn">titus.datatype</span>
<span class="kn">import</span> <span class="nn">titus.fcn</span>
<span class="kn">import</span> <span class="nn">titus.options</span>
<span class="kn">import</span> <span class="nn">titus.P</span> <span class="kn">as</span> <span class="nn">P</span>
<span class="kn">import</span> <span class="nn">titus.reader</span>
<span class="kn">import</span> <span class="nn">titus.signature</span>
<span class="kn">import</span> <span class="nn">titus.util</span>
<span class="kn">from</span> <span class="nn">titus.util</span> <span class="kn">import</span> <span class="n">DynamicScope</span>

<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">EngineConfig</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Cell</span> <span class="k">as</span> <span class="n">AstCell</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">AstPool</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">FcnDef</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">FcnRef</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">FcnRefFill</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">CallUserFcn</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Call</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Ref</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">LiteralNull</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">LiteralBoolean</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">LiteralInt</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">LiteralLong</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">LiteralFloat</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">LiteralDouble</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">LiteralString</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">LiteralBase64</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">NewObject</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">NewArray</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Do</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Let</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">SetVar</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">AttrGet</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">AttrTo</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">CellGet</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">CellTo</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">PoolGet</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">PoolTo</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">If</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Cond</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">While</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">DoUntil</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">For</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Foreach</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Forkeyval</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">CastCase</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">CastBlock</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Upcast</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">IfNotNull</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">BinaryFormatter</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Pack</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Unpack</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Doc</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Error</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Try</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Log</span>

<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">Method</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">ArrayIndex</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">MapIndex</span>
<span class="kn">from</span> <span class="nn">titus.pfaast</span> <span class="kn">import</span> <span class="n">RecordIndex</span>

<div class="viewcode-block" id="GeneratePython"><a class="viewcode-back" href="../../titus.html#titus.genpy.GeneratePython">[docs]</a><span class="k">class</span> <span class="nc">GeneratePython</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">pfaast</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GeneratePython.makeTask"><a class="viewcode-back" href="../../titus.html#titus.genpy.GeneratePython.makeTask">[docs]</a>    <span class="k">def</span> <span class="nf">makeTask</span><span class="p">(</span><span class="n">style</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s">&quot;pure&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GeneratePythonPure</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;unrecognized style &quot;</span> <span class="o">+</span> <span class="n">style</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneratePython.commandsMap"><a class="viewcode-back" href="../../titus.html#titus.genpy.GeneratePython.commandsMap">[docs]</a>    <span class="k">def</span> <span class="nf">commandsMap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;self.actionsFinished += 1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> \
                 <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;return last</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;last = &quot;</span> <span class="o">+</span> <span class="n">codes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">suffix</span>
</div>
<div class="viewcode-block" id="GeneratePython.commandsEmit"><a class="viewcode-back" href="../../titus.html#titus.genpy.GeneratePython.commandsEmit">[docs]</a>    <span class="k">def</span> <span class="nf">commandsEmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;self.actionsFinished += 1</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">)</span> <span class="o">+</span> <span class="n">suffix</span>
</div>
<div class="viewcode-block" id="GeneratePython.commandsFold"><a class="viewcode-back" href="../../titus.html#titus.genpy.GeneratePython.commandsFold">[docs]</a>    <span class="k">def</span> <span class="nf">commandsFold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;scope.let({&#39;tally&#39;: self.tally})</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;self.tally = last</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> \
                 <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;self.actionsFinished += 1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> \
                 <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;return self.tally</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;last = &quot;</span> <span class="o">+</span> <span class="n">codes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">suffix</span>
</div>
<div class="viewcode-block" id="GeneratePython.commandsFoldMerge"><a class="viewcode-back" href="../../titus.html#titus.genpy.GeneratePython.commandsFoldMerge">[docs]</a>    <span class="k">def</span> <span class="nf">commandsFoldMerge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;self.tally = last</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> \
                 <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;return self.tally</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;last = &quot;</span> <span class="o">+</span> <span class="n">codes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">suffix</span>
</div>
<div class="viewcode-block" id="GeneratePython.commandsBeginEnd"><a class="viewcode-back" href="../../titus.html#titus.genpy.GeneratePython.commandsBeginEnd">[docs]</a>    <span class="k">def</span> <span class="nf">commandsBeginEnd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneratePython.reprPath"><a class="viewcode-back" href="../../titus.html#titus.genpy.GeneratePython.reprPath">[docs]</a>    <span class="k">def</span> <span class="nf">reprPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ArrayIndex</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MapIndex</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">RecordIndex</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">f</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="k">return</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">EngineConfig</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">uniqueEngineName</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">name</span>

            <span class="n">begin</span><span class="p">,</span> <span class="n">beginSymbols</span><span class="p">,</span> <span class="n">beginCalls</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">begin</span>
            <span class="n">action</span><span class="p">,</span> <span class="n">actionSymbols</span><span class="p">,</span> <span class="n">actionCalls</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">action</span>
            <span class="n">end</span><span class="p">,</span> <span class="n">endSymbols</span><span class="p">,</span> <span class="n">endCalls</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">end</span>

            <span class="n">callGraph</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;(begin)&quot;</span><span class="p">:</span> <span class="n">beginCalls</span><span class="p">,</span> <span class="s">&quot;(action)&quot;</span><span class="p">:</span> <span class="n">actionCalls</span><span class="p">,</span> <span class="s">&quot;(end)&quot;</span><span class="p">:</span> <span class="n">endCalls</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">merge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">mergeTasks</span><span class="p">,</span> <span class="n">mergeSymbols</span><span class="p">,</span> <span class="n">mergeCalls</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">merge</span>
                <span class="n">callGraph</span><span class="p">[</span><span class="s">&quot;(merge)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mergeCalls</span>
            <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fctx</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">fcns</span><span class="p">:</span>
                <span class="n">callGraph</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fctx</span><span class="o">.</span><span class="n">calls</span>

            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;class PFA_&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;&quot;&quot;(PFAEngine):</span>
<span class="s">    def __init__(self, cells, pools, config, options, log, emit, zero, instance, rand):</span>
<span class="s">        self.actionsStarted = 0</span>
<span class="s">        self.actionsFinished = 0</span>
<span class="s">        self.cells = cells</span>
<span class="s">        self.pools = pools</span>
<span class="s">        self.config = config</span>
<span class="s">        self.inputType = config.input</span>
<span class="s">        self.outputType = config.output</span>
<span class="s">        self.options = options</span>
<span class="s">        self.log = log</span>
<span class="s">        self.emit = emit</span>
<span class="s">        self.instance = instance</span>
<span class="s">        self.rand = rand</span>
<span class="s">        self.callGraph = &quot;&quot;&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">callGraph</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">FOLD</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;        self.tally = zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;    def initialize(self):</span>
<span class="s">        self</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ufname</span><span class="p">,</span> <span class="n">fcnContext</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">fcns</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;        self.f[&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ufname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;] = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="p">(</span><span class="n">fcnContext</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    def begin(self):</span>
<span class="s">        state = ExecutionState(self.options, self.rand, &#39;action&#39;, self.parser)</span>
<span class="s">        scope = DynamicScope(None)</span>
<span class="s">        scope.let({&#39;name&#39;: self.config.name, &#39;instance&#39;: self.instance, &#39;metadata&#39;: self.config.metadata})</span>
<span class="s">        if self.config.version is not None:</span>
<span class="s">            scope.let({&#39;version&#39;: self.config.version})</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandsBeginEnd</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="s">&quot;        &quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    def begin(self):</span>
<span class="s">        pass</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">MAP</span><span class="p">:</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandsMap</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s">&quot;            &quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">context</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">EMIT</span><span class="p">:</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandsEmit</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s">&quot;            &quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">context</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">FOLD</span><span class="p">:</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandsFold</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s">&quot;            &quot;</span><span class="p">)</span>

            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    def action(self, input, check=True):</span>
<span class="s">        if check:</span>
<span class="s">            input = checkData(input, self.inputType)</span>
<span class="s">        state = ExecutionState(self.options, self.rand, &#39;action&#39;, self.parser)</span>
<span class="s">        scope = DynamicScope(None)</span>
<span class="s">        for cell in self.cells.values():</span>
<span class="s">            cell.maybeSaveBackup()</span>
<span class="s">        for pool in self.pools.values():</span>
<span class="s">            pool.maybeSaveBackup()</span>
<span class="s">        self.actionsStarted += 1</span>
<span class="s">        try:</span>
<span class="s">            scope.let({&#39;input&#39;: input, &#39;name&#39;: self.config.name, &#39;instance&#39;: self.instance, &#39;metadata&#39;: self.config.metadata, &#39;actionsStarted&#39;: self.actionsStarted, &#39;actionsFinished&#39;: self.actionsFinished})</span>
<span class="s">            if self.config.version is not None:</span>
<span class="s">                scope.let({&#39;version&#39;: self.config.version})</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">commands</span><span class="p">)</span>

            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;        except Exception:</span>
<span class="s">            for cell in self.cells.values():</span>
<span class="s">                cell.maybeRestoreBackup()</span>
<span class="s">            for pool in self.pools.values():</span>
<span class="s">                pool.maybeRestoreBackup()</span>
<span class="s">            raise</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">merge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    def merge(self, tallyOne, tallyTwo):</span>
<span class="s">        state = ExecutionState(self.options, self.rand, &#39;merge&#39;, self.parser)</span>
<span class="s">        scope = DynamicScope(None)</span>
<span class="s">        for cell in self.cells.values():</span>
<span class="s">            cell.maybeSaveBackup()</span>
<span class="s">        for pool in self.pools.values():</span>
<span class="s">            pool.maybeSaveBackup()</span>
<span class="s">        try:</span>
<span class="s">            scope.let({&#39;tallyOne&#39;: tallyOne, &#39;tallyTwo&#39;: tallyTwo, &#39;name&#39;: self.config.name, &#39;instance&#39;: self.instance, &#39;metadata&#39;: self.config.metadata})</span>
<span class="s">            if self.config.version is not None:</span>
<span class="s">                scope.let({&#39;version&#39;: self.config.version})</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandsFoldMerge</span><span class="p">(</span><span class="n">mergeTasks</span><span class="p">,</span> <span class="s">&quot;            &quot;</span><span class="p">))</span>

                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;        except Exception:</span>
<span class="s">            for cell in self.cells.values():</span>
<span class="s">                cell.maybeRestoreBackup()</span>
<span class="s">            for pool in self.pools.values():</span>
<span class="s">                pool.maybeRestoreBackup()</span>
<span class="s">            raise</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tallyLine</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">FOLD</span><span class="p">:</span>
                    <span class="n">tallyLine</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;        scope.let({&#39;tally&#39;: self.tally})</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
                
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    def end(self):</span>
<span class="s">        state = ExecutionState(self.options, self.rand, &#39;action&#39;, self.parser)</span>
<span class="s">        scope = DynamicScope(None)</span>
<span class="s">        scope.let({&#39;name&#39;: self.config.name, &#39;instance&#39;: self.instance, &#39;metadata&#39;: self.config.metadata, &#39;actionsStarted&#39;: self.actionsStarted, &#39;actionsFinished&#39;: self.actionsFinished})</span>
<span class="s">        if self.config.version is not None:</span>
<span class="s">            scope.let({&#39;version&#39;: self.config.version})</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">tallyLine</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandsBeginEnd</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s">&quot;        &quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    def end(self):</span>
<span class="s">        pass</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">FcnDef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;labeledFcn(lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;), [&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">paramNames</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;])&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">FcnRef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;self.f[&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">fcn</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">FcnRefFill</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="n">reducedArgs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">$&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">fcnType</span><span class="o">.</span><span class="n">params</span><span class="p">))]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">originalParamNames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">argTypeResult</span><span class="p">:</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">argTypeResult</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;scope.get(</span><span class="se">\&quot;</span><span class="s">$&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">)&quot;</span><span class="p">)</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="s">&quot;labeledFcn(lambda state, scope: call(state, DynamicScope(scope), self.f[&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">fcn</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;], [&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]), [&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reducedArgs</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;])&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CallUserFcn</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;call(state, DynamicScope(None), self.f[&#39;u.&#39; + &quot;</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;], [&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;])&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Call</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">fcn</span><span class="o">.</span><span class="n">genpy</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">paramTypes</span> <span class="o">+</span> <span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">retType</span><span class="p">],</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Ref</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;scope.get({0})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">LiteralNull</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;None&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">LiteralBoolean</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">LiteralInt</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">LiteralLong</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">LiteralFloat</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">LiteralDouble</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">LiteralString</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">LiteralBase64</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Literal</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">jsonDecoder</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">NewObject</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;{&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">NewArray</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;[&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Do</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Let</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;scope.let({&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">e</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">nameTypeExpr</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;})&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">SetVar</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;scope.set({&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">e</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">nameTypeExpr</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;})&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">AttrGet</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;get(&quot;</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="n">expr</span> <span class="o">+</span> <span class="s">&quot;, [&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reprPath</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;])&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">AttrTo</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;update(state, scope, {0}, [{1}], {2})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reprPath</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="n">context</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CellGet</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;get(self.cells[{0}].value, [{1}])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">cell</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reprPath</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CellTo</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;self.cells[{0}].update(state, scope, [{1}], {2})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">cell</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reprPath</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="n">context</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">PoolGet</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;get(self.pools[{0}].value, [{1}])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">pool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reprPath</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">PoolTo</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;self.pools[{0}].update(state, scope, [{1}], {2}, {3})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">pool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reprPath</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="n">context</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">If</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;ifThen(state, scope, lambda state, scope: {0}, lambda state, scope: do({1}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">predicate</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">thenClause</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;ifThenElse(state, scope, lambda state, scope: {0}, lambda state, scope: do({1}), lambda state, scope: do({2}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">predicate</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">thenClause</span><span class="p">),</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">elseClause</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Cond</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">complete</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;cond(state, scope, [{0}])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;(lambda state, scope: {0}, lambda state, scope: do({1}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">walkBlock</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">walkBlock</span><span class="o">.</span><span class="n">exprs</span><span class="p">))</span> <span class="k">for</span> <span class="n">walkBlock</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">walkBlocks</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;condElse(state, scope, [{0}], lambda state, scope: do({1}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;(lambda state, scope: {0}, lambda state, scope: do({1}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">walkBlock</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">walkBlock</span><span class="o">.</span><span class="n">exprs</span><span class="p">))</span> <span class="k">for</span> <span class="n">walkBlock</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">walkBlocks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">walkBlocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">exprs</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">While</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;doWhile(state, scope, lambda state, scope: {0}, lambda state, scope: do({1}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">predicate</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">loopBody</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">DoUntil</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;doUntil(state, scope, lambda state, scope: {0}, lambda state, scope: do({1}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">predicate</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">loopBody</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">For</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;doFor(state, scope, lambda state, scope: scope.let({&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">e</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">initNameTypeExpr</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}), lambda state, scope: &quot;</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="n">predicate</span> <span class="o">+</span> <span class="s">&quot;, lambda state, scope: scope.set({&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">e</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">stepNameTypeExpr</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}), lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">loopBody</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;))&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Foreach</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;doForeach(state, scope, {0}, {1}, lambda state, scope: do({2}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">context</span><span class="o">.</span><span class="n">objExpr</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">loopBody</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Forkeyval</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;doForkeyval(state, scope, {0}, {1}, {2}, lambda state, scope: do({3}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">forkey</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">forval</span><span class="p">),</span> <span class="n">context</span><span class="o">.</span><span class="n">objExpr</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">loopBody</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CastCase</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">toType</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">clause</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;))&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CastBlock</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;cast(state, scope, &quot;</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="n">expr</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">exprType</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, [&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">caseRes</span> <span class="k">for</span> <span class="n">castCtx</span><span class="p">,</span> <span class="n">caseRes</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;], &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">partial</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, self.parser)&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Upcast</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">expr</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">IfNotNull</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;ifNotNull(state, scope, {&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">e</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">symbolTypeResult</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}, {&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &#39;&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">symbolTypeResult</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}, lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;))&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;ifNotNullElse(state, scope, {&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">e</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">symbolTypeResult</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}, {&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &#39;&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">symbolTypeResult</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}, lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;), lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">elseClause</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;))&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Pack</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;pack(state, scope, [&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">exprsDeclareRes</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;])&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Unpack</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;unpack(state, scope, &quot;</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="n">bytes</span> <span class="o">+</span> <span class="s">&quot;, [&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">formatter</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;], lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;))&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;unpackElse(state, scope, &quot;</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="n">bytes</span> <span class="o">+</span> <span class="s">&quot;, [&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">formatter</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;], lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;), lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">elseClause</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;))&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Doc</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;None&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Error</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;error(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">code</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Try</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;tryCatch(state, scope, lambda state, scope: do(&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;), &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Log</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;self.log([{0}], {1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">exprTypes</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">namespace</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;unrecognized context class: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">context</span><span class="p">)),</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneratePythonPure"><a class="viewcode-back" href="../../titus.html#titus.genpy.GeneratePythonPure">[docs]</a><span class="k">class</span> <span class="nc">GeneratePythonPure</span><span class="p">(</span><span class="n">GeneratePython</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c">###########################################################################</span>
</div>
<div class="viewcode-block" id="ExecutionState"><a class="viewcode-back" href="../../titus.html#titus.genpy.ExecutionState">[docs]</a><span class="k">class</span> <span class="nc">ExecutionState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">rand</span><span class="p">,</span> <span class="n">routine</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rand</span> <span class="o">=</span> <span class="n">rand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>

        <span class="k">if</span> <span class="n">routine</span> <span class="o">==</span> <span class="s">&quot;begin&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">timeout_begin</span>
        <span class="k">elif</span> <span class="n">routine</span> <span class="o">==</span> <span class="s">&quot;action&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">timeout_action</span>
        <span class="k">elif</span> <span class="n">routine</span> <span class="o">==</span> <span class="s">&quot;end&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">timeout_end</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<div class="viewcode-block" id="ExecutionState.checkTime"><a class="viewcode-back" href="../../titus.html#titus.genpy.ExecutionState.checkTime">[docs]</a>    <span class="k">def</span> <span class="nf">checkTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFATimeoutException</span><span class="p">(</span><span class="s">&quot;exceeded timeout of {0} milliseconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">))</span>
</div></div>
<div class="viewcode-block" id="SharedState"><a class="viewcode-back" href="../../titus.html#titus.genpy.SharedState">[docs]</a><span class="k">class</span> <span class="nc">SharedState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pools</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;SharedState({0} cells, {1} pools)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="PersistentStorageItem"><a class="viewcode-back" href="../../titus.html#titus.genpy.PersistentStorageItem">[docs]</a><span class="k">class</span> <span class="nc">PersistentStorageItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">rollback</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="o">=</span> <span class="n">shared</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span> <span class="o">=</span> <span class="n">rollback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
</div>
<div class="viewcode-block" id="Cell"><a class="viewcode-back" href="../../titus.html#titus.genpy.Cell">[docs]</a><span class="k">class</span> <span class="nc">Cell</span><span class="p">(</span><span class="n">PersistentStorageItem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">rollback</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Cell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">rollback</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[:</span><span class="mi">27</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;...&quot;</span>
        <span class="k">return</span> <span class="s">&quot;Cell(&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;shared, &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;rollback, &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">contents</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
            
<div class="viewcode-block" id="Cell.update"><a class="viewcode-back" href="../../titus.html#titus.genpy.Cell.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="Cell.maybeSaveBackup"><a class="viewcode-back" href="../../titus.html#titus.genpy.Cell.maybeSaveBackup">[docs]</a>    <span class="k">def</span> <span class="nf">maybeSaveBackup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oldvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</div>
<div class="viewcode-block" id="Cell.maybeRestoreBackup"><a class="viewcode-back" href="../../titus.html#titus.genpy.Cell.maybeRestoreBackup">[docs]</a>    <span class="k">def</span> <span class="nf">maybeRestoreBackup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldvalue</span>
</div></div>
<div class="viewcode-block" id="Pool"><a class="viewcode-back" href="../../titus.html#titus.genpy.Pool">[docs]</a><span class="k">class</span> <span class="nc">Pool</span><span class="p">(</span><span class="n">PersistentStorageItem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">rollback</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locklock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Pool</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">rollback</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[:</span><span class="mi">27</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;...&quot;</span>
        <span class="k">return</span> <span class="s">&quot;Pool(&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;shared, &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;rollback, &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">contents</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>

<div class="viewcode-block" id="Pool.update"><a class="viewcode-back" href="../../titus.html#titus.genpy.Pool.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">init</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locklock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">head</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">head</span><span class="p">]</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">head</span><span class="p">]</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locklock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">head</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">head</span><span class="p">],</span> <span class="n">tail</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">head</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">head</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">head</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">head</span><span class="p">],</span> <span class="n">tail</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">head</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="Pool.maybeSaveBackup"><a class="viewcode-back" href="../../titus.html#titus.genpy.Pool.maybeSaveBackup">[docs]</a>    <span class="k">def</span> <span class="nf">maybeSaveBackup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oldvalue</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pool.maybeRestoreBackup"><a class="viewcode-back" href="../../titus.html#titus.genpy.Pool.maybeRestoreBackup">[docs]</a>    <span class="k">def</span> <span class="nf">maybeRestoreBackup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldvalue</span>
</div></div>
<div class="viewcode-block" id="labeledFcn"><a class="viewcode-back" href="../../titus.html#titus.genpy.labeledFcn">[docs]</a><span class="k">def</span> <span class="nf">labeledFcn</span><span class="p">(</span><span class="n">fcn</span><span class="p">,</span> <span class="n">paramNames</span><span class="p">):</span>
    <span class="n">fcn</span><span class="o">.</span><span class="n">paramNames</span> <span class="o">=</span> <span class="n">paramNames</span>
    <span class="k">return</span> <span class="n">fcn</span>
</div>
<div class="viewcode-block" id="get"><a class="viewcode-back" href="../../titus.html#titus.genpy.get">[docs]</a><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="n">head</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">PFARuntimeException</span><span class="p">(</span><span class="s">&quot;index {0} out of bounds for array of size {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFARuntimeException</span><span class="p">(</span><span class="s">&quot;key </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> not found in map with size {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">tail</span>

    <span class="k">return</span> <span class="n">obj</span>
</div>
<div class="viewcode-block" id="update"><a class="viewcode-back" href="../../titus.html#titus.genpy.update">[docs]</a><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">head</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">head</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">to</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">to</span><span class="p">):</span>
        <span class="n">callScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
        <span class="n">callScope</span><span class="o">.</span><span class="n">let</span><span class="p">({</span><span class="n">to</span><span class="o">.</span><span class="n">paramNames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">obj</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">to</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">callScope</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">to</span>
        </div>
<div class="viewcode-block" id="do"><a class="viewcode-back" href="../../titus.html#titus.genpy.do">[docs]</a><span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="o">*</span><span class="n">exprs</span><span class="p">):</span>
    <span class="c"># You&#39;ve already done them; just return the right value.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exprs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">exprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="ifThen"><a class="viewcode-back" href="../../titus.html#titus.genpy.ifThen">[docs]</a><span class="k">def</span> <span class="nf">ifThen</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)):</span>
        <span class="n">thenClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="ifThenElse"><a class="viewcode-back" href="../../titus.html#titus.genpy.ifThenElse">[docs]</a><span class="k">def</span> <span class="nf">ifThenElse</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">thenClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">elseClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="cond"><a class="viewcode-back" href="../../titus.html#titus.genpy.cond">[docs]</a><span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">ifThens</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">thenClause</span> <span class="ow">in</span> <span class="n">ifThens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)):</span>
            <span class="n">thenClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">))</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="condElse"><a class="viewcode-back" href="../../titus.html#titus.genpy.condElse">[docs]</a><span class="k">def</span> <span class="nf">condElse</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">ifThens</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">thenClause</span> <span class="ow">in</span> <span class="n">ifThens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">thenClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">elseClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="doWhile"><a class="viewcode-back" href="../../titus.html#titus.genpy.doWhile">[docs]</a><span class="k">def</span> <span class="nf">doWhile</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">):</span>
    <span class="n">bodyScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">predScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">bodyScope</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">predicate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">predScope</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">checkTime</span><span class="p">()</span>
        <span class="n">loopBody</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bodyScope</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>
    </div>
<div class="viewcode-block" id="doUntil"><a class="viewcode-back" href="../../titus.html#titus.genpy.doUntil">[docs]</a><span class="k">def</span> <span class="nf">doUntil</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">):</span>
    <span class="n">bodyScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">predScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">bodyScope</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">checkTime</span><span class="p">()</span>
        <span class="n">loopBody</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bodyScope</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">predScope</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="doFor"><a class="viewcode-back" href="../../titus.html#titus.genpy.doFor">[docs]</a><span class="k">def</span> <span class="nf">doFor</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">initLet</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">stepSet</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">):</span>
    <span class="n">loopScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">predScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">loopScope</span><span class="p">)</span>
    <span class="n">bodyScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">loopScope</span><span class="p">)</span>
    <span class="n">initLet</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">loopScope</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">predicate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">predScope</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">checkTime</span><span class="p">()</span>
        <span class="n">loopBody</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bodyScope</span><span class="p">)</span>
        <span class="n">stepSet</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">loopScope</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="doForeach"><a class="viewcode-back" href="../../titus.html#titus.genpy.doForeach">[docs]</a><span class="k">def</span> <span class="nf">doForeach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">):</span>
    <span class="n">loopScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">bodyScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">loopScope</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">checkTime</span><span class="p">()</span>
        <span class="n">loopScope</span><span class="o">.</span><span class="n">let</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">item</span><span class="p">})</span>
        <span class="n">loopBody</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bodyScope</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="doForkeyval"><a class="viewcode-back" href="../../titus.html#titus.genpy.doForkeyval">[docs]</a><span class="k">def</span> <span class="nf">doForkeyval</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">forkey</span><span class="p">,</span> <span class="n">forval</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">):</span>
    <span class="n">loopScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">bodyScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">loopScope</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">state</span><span class="o">.</span><span class="n">checkTime</span><span class="p">()</span>
        <span class="n">loopScope</span><span class="o">.</span><span class="n">let</span><span class="p">({</span><span class="n">forkey</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="n">forval</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
        <span class="n">loopBody</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bodyScope</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>
        </div>
<div class="viewcode-block" id="cast"><a class="viewcode-back" href="../../titus.html#titus.genpy.cast">[docs]</a><span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">fromType</span><span class="p">,</span> <span class="n">cases</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="n">fromType</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getAvroType</span><span class="p">(</span><span class="n">fromType</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">toType</span><span class="p">,</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
        <span class="n">toType</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getAvroType</span><span class="p">(</span><span class="n">toType</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fromType</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroUnion</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tag</span><span class="p">,</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">value</span><span class="p">,</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">tag</span> <span class="o">==</span> <span class="n">toType</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;int&quot;</span> <span class="ow">and</span> <span class="n">toType</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;long&quot;</span><span class="p">,</span> <span class="s">&quot;float&quot;</span><span class="p">,</span> <span class="s">&quot;double&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;long&quot;</span> <span class="ow">and</span> <span class="n">toType</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;float&quot;</span><span class="p">,</span> <span class="s">&quot;double&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;float&quot;</span> <span class="ow">and</span> <span class="n">toType</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;double&quot;</span><span class="p">)):</span>
                <span class="k">continue</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">expr</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">castValue</span> <span class="o">=</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">jsonDecoder</span><span class="p">(</span><span class="n">toType</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">AvroException</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clauseScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
            <span class="n">clauseScope</span><span class="o">.</span><span class="n">let</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">castValue</span><span class="p">})</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">clause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">clauseScope</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">partial</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">out</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="untagUnions"><a class="viewcode-back" href="../../titus.html#titus.genpy.untagUnions">[docs]</a><span class="k">def</span> <span class="nf">untagUnions</span><span class="p">(</span><span class="n">nameExpr</span><span class="p">,</span> <span class="n">nameType</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">nameExpr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tag</span><span class="p">,</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">value</span><span class="p">,</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

            <span class="n">expectedTag</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">nameType</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expectedTag</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">expectedTag</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;record&quot;</span><span class="p">,</span> <span class="s">&quot;enum&quot;</span><span class="p">,</span> <span class="s">&quot;fixed&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s">&quot;namespace&quot;</span> <span class="ow">in</span> <span class="n">expectedTag</span> <span class="ow">and</span> <span class="n">expectedTag</span><span class="p">[</span><span class="s">&quot;namespace&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">expectedTag</span> <span class="o">=</span> <span class="n">expectedTag</span><span class="p">[</span><span class="s">&quot;namespace&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">expectedTag</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">expectedTag</span> <span class="o">=</span> <span class="n">expectedTag</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expectedTag</span> <span class="o">=</span> <span class="n">expectedTag</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">expectedTag</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>

    <span class="k">return</span> <span class="n">out</span>
</div>
<div class="viewcode-block" id="ifNotNull"><a class="viewcode-back" href="../../titus.html#titus.genpy.ifNotNull">[docs]</a><span class="k">def</span> <span class="nf">ifNotNull</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">nameExpr</span><span class="p">,</span> <span class="n">nameType</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nameExpr</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">thenScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
        <span class="n">thenScope</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">untagUnions</span><span class="p">(</span><span class="n">nameExpr</span><span class="p">,</span> <span class="n">nameType</span><span class="p">))</span>
        <span class="n">thenClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ifNotNullElse"><a class="viewcode-back" href="../../titus.html#titus.genpy.ifNotNullElse">[docs]</a><span class="k">def</span> <span class="nf">ifNotNullElse</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">nameExpr</span><span class="p">,</span> <span class="n">nameType</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nameExpr</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">thenScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
        <span class="n">thenScope</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">untagUnions</span><span class="p">(</span><span class="n">nameExpr</span><span class="p">,</span> <span class="n">nameType</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">thenClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">elseClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="pack"><a class="viewcode-back" href="../../titus.html#titus.genpy.pack">[docs]</a><span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">exprsDeclareRes</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="n">exprsDeclareRes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s">&quot;raw&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFARuntimeException</span><span class="p">(</span><span class="s">&quot;raw bytes expression does not have size &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s">&quot;tonull&quot;</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s">&quot;prefixed&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFARuntimeException</span><span class="p">(</span><span class="s">&quot;length prefixed bytes expression is larger than 255 bytes&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s">&quot;x&quot;</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MisalignedPacking"><a class="viewcode-back" href="../../titus.html#titus.genpy.MisalignedPacking">[docs]</a><span class="k">class</span> <span class="nc">MisalignedPacking</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
</div>
<div class="viewcode-block" id="unpackOne"><a class="viewcode-back" href="../../titus.html#titus.genpy.unpackOne">[docs]</a><span class="k">def</span> <span class="nf">unpackOne</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s">&quot;raw&quot;</span><span class="p">:</span>
        <span class="n">this</span><span class="p">,</span> <span class="n">that</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[:</span><span class="n">l</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">[</span><span class="n">l</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">!=</span> <span class="n">l</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MisalignedPacking</span><span class="p">()</span>
        <span class="n">scope</span><span class="o">.</span><span class="n">let</span><span class="p">({</span><span class="n">s</span><span class="p">:</span> <span class="n">this</span><span class="p">})</span>

    <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s">&quot;tonull&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nullbyte</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MisalignedPacking</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">this</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[:</span><span class="n">nullbyte</span><span class="p">]</span>
            <span class="n">that</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[(</span><span class="n">nullbyte</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>
            <span class="n">scope</span><span class="o">.</span><span class="n">let</span><span class="p">({</span><span class="n">s</span><span class="p">:</span> <span class="n">this</span><span class="p">})</span>

    <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s">&quot;prefixed&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MisalignedPacking</span><span class="p">()</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">this</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">:(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">that</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MisalignedPacking</span><span class="p">()</span>
        <span class="n">scope</span><span class="o">.</span><span class="n">let</span><span class="p">({</span><span class="n">s</span><span class="p">:</span> <span class="n">this</span><span class="p">})</span>

    <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s">&quot;x&quot;</span><span class="p">:</span>
        <span class="n">this</span><span class="p">,</span> <span class="n">that</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[:</span><span class="n">l</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">[</span><span class="n">l</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">!=</span> <span class="n">l</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MisalignedPacking</span><span class="p">()</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
        <span class="n">scope</span><span class="o">.</span><span class="n">let</span><span class="p">({</span><span class="n">s</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">this</span><span class="p">,</span> <span class="n">that</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[:</span><span class="n">l</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">[</span><span class="n">l</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">!=</span> <span class="n">l</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MisalignedPacking</span><span class="p">()</span>
        <span class="n">value</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
        <span class="n">scope</span><span class="o">.</span><span class="n">let</span><span class="p">({</span><span class="n">s</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">that</span>
</div>
<div class="viewcode-block" id="unpack"><a class="viewcode-back" href="../../titus.html#titus.genpy.unpack">[docs]</a><span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">):</span>
    <span class="n">thenScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">format</span><span class="p">:</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="n">unpackOne</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">MisalignedPacking</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">thenClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="unpackElse"><a class="viewcode-back" href="../../titus.html#titus.genpy.unpackElse">[docs]</a><span class="k">def</span> <span class="nf">unpackElse</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">):</span>
    <span class="n">thenScope</span> <span class="o">=</span> <span class="n">DynamicScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">format</span><span class="p">:</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="n">unpackOne</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">MisalignedPacking</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">elseClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">elseClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">thenClause</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="error"><a class="viewcode-back" href="../../titus.html#titus.genpy.error">[docs]</a><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">PFAUserException</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="tryCatch"><a class="viewcode-back" href="../../titus.html#titus.genpy.tryCatch">[docs]</a><span class="k">def</span> <span class="nf">tryCatch</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">exprs</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">exprs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">err</span><span class="o">.</span><span class="n">message</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>
</div>
<div class="viewcode-block" id="genericLog"><a class="viewcode-back" href="../../titus.html#titus.genpy.genericLog">[docs]</a><span class="k">def</span> <span class="nf">genericLog</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="FakeEmitForExecution"><a class="viewcode-back" href="../../titus.html#titus.genpy.FakeEmitForExecution">[docs]</a><span class="k">class</span> <span class="nc">FakeEmitForExecution</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">fcn</span><span class="o">.</span><span class="n">Fcn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
</div>
<div class="viewcode-block" id="genericEmit"><a class="viewcode-back" href="../../titus.html#titus.genpy.genericEmit">[docs]</a><span class="k">def</span> <span class="nf">genericEmit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="checkForDeadlock"><a class="viewcode-back" href="../../titus.html#titus.genpy.checkForDeadlock">[docs]</a><span class="k">def</span> <span class="nf">checkForDeadlock</span><span class="p">(</span><span class="n">engineConfig</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">WithFcnRef</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ast</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="p">(</span><span class="n">CellTo</span><span class="p">,</span> <span class="n">PoolTo</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="p">(</span><span class="n">FcnRef</span><span class="p">,</span> <span class="n">FcnRefFill</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slotTo</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">hasSideEffects</span><span class="p">(</span><span class="n">slotTo</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFAInitializationException</span><span class="p">(</span><span class="s">&quot;{0} references function </span><span class="se">\&quot;</span><span class="s">{1}</span><span class="se">\&quot;</span><span class="s">, which has side-effects&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slotTo</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="n">slotTo</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">engineConfig</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">WithFcnRef</span><span class="p">())</span>

    <span class="k">class</span> <span class="nc">CellToOrPoolTo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ast</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="p">(</span><span class="n">CellTo</span><span class="p">,</span> <span class="n">PoolTo</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slotTo</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFAInitializationException</span><span class="p">(</span><span class="s">&quot;inline function in cell-to or pool-to invokes a &quot;</span> <span class="o">+</span> <span class="n">slotTo</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">SideEffectFunction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ast</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">Call</span><span class="p">)</span> <span class="ow">and</span> <span class="n">engine</span><span class="o">.</span><span class="n">hasSideEffects</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFAInitializationException</span><span class="p">(</span><span class="s">&quot;inline function in cell-to or pool-to invokes function </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">, which has side-effects&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">class</span> <span class="nc">WithFcnDef</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ast</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="p">(</span><span class="n">CellTo</span><span class="p">,</span> <span class="n">PoolTo</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">FcnDef</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slotTo</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">slotTo</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">CellToOrPoolTo</span><span class="p">())</span>
                <span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">SideEffectFunction</span><span class="p">())</span>
    <span class="n">engineConfig</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">WithFcnDef</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="PFAEngine"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine">[docs]</a><span class="k">class</span> <span class="nc">PFAEngine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="PFAEngine.fromAst"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.fromAst">[docs]</a>    <span class="k">def</span> <span class="nf">fromAst</span><span class="p">(</span><span class="n">engineConfig</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sharedState</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;pure&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">functionTable</span> <span class="o">=</span> <span class="n">titus</span><span class="o">.</span><span class="n">pfaast</span><span class="o">.</span><span class="n">FunctionTable</span><span class="o">.</span><span class="n">blank</span><span class="p">()</span>

        <span class="n">engineOptions</span> <span class="o">=</span> <span class="n">titus</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">EngineOptions</span><span class="p">(</span><span class="n">engineConfig</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="n">context</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">engineConfig</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">GeneratePython</span><span class="o">.</span><span class="n">makeTask</span><span class="p">(</span><span class="n">style</span><span class="p">),</span> <span class="n">titus</span><span class="o">.</span><span class="n">pfaast</span><span class="o">.</span><span class="n">SymbolTable</span><span class="o">.</span><span class="n">blank</span><span class="p">(),</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">code</span>

        <span class="n">sandbox</span> <span class="o">=</span> <span class="p">{</span><span class="c"># Scoring engine architecture</span>
                   <span class="s">&quot;PFAEngine&quot;</span><span class="p">:</span> <span class="n">PFAEngine</span><span class="p">,</span>
                   <span class="s">&quot;ExecutionState&quot;</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">,</span>
                   <span class="s">&quot;DynamicScope&quot;</span><span class="p">:</span> <span class="n">DynamicScope</span><span class="p">,</span>
                   <span class="c"># Python statement --&gt; expression wrappers</span>
                   <span class="s">&quot;labeledFcn&quot;</span><span class="p">:</span> <span class="n">labeledFcn</span><span class="p">,</span>
                   <span class="s">&quot;call&quot;</span><span class="p">:</span> <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">callfcn</span><span class="p">,</span>
                   <span class="s">&quot;get&quot;</span><span class="p">:</span> <span class="n">get</span><span class="p">,</span>
                   <span class="s">&quot;update&quot;</span><span class="p">:</span> <span class="n">update</span><span class="p">,</span>
                   <span class="s">&quot;do&quot;</span><span class="p">:</span> <span class="n">do</span><span class="p">,</span>
                   <span class="s">&quot;ifThen&quot;</span><span class="p">:</span> <span class="n">ifThen</span><span class="p">,</span>
                   <span class="s">&quot;ifThenElse&quot;</span><span class="p">:</span> <span class="n">ifThenElse</span><span class="p">,</span>
                   <span class="s">&quot;cond&quot;</span><span class="p">:</span> <span class="n">cond</span><span class="p">,</span>
                   <span class="s">&quot;condElse&quot;</span><span class="p">:</span> <span class="n">condElse</span><span class="p">,</span>
                   <span class="s">&quot;doWhile&quot;</span><span class="p">:</span> <span class="n">doWhile</span><span class="p">,</span>
                   <span class="s">&quot;doUntil&quot;</span><span class="p">:</span> <span class="n">doUntil</span><span class="p">,</span>
                   <span class="s">&quot;doFor&quot;</span><span class="p">:</span> <span class="n">doFor</span><span class="p">,</span>
                   <span class="s">&quot;doForeach&quot;</span><span class="p">:</span> <span class="n">doForeach</span><span class="p">,</span>
                   <span class="s">&quot;doForkeyval&quot;</span><span class="p">:</span> <span class="n">doForkeyval</span><span class="p">,</span>
                   <span class="s">&quot;cast&quot;</span><span class="p">:</span> <span class="n">cast</span><span class="p">,</span>
                   <span class="s">&quot;ifNotNull&quot;</span><span class="p">:</span> <span class="n">ifNotNull</span><span class="p">,</span>
                   <span class="s">&quot;ifNotNullElse&quot;</span><span class="p">:</span> <span class="n">ifNotNullElse</span><span class="p">,</span>
                   <span class="s">&quot;pack&quot;</span><span class="p">:</span> <span class="n">pack</span><span class="p">,</span>
                   <span class="s">&quot;unpack&quot;</span><span class="p">:</span> <span class="n">unpack</span><span class="p">,</span>
                   <span class="s">&quot;unpackElse&quot;</span><span class="p">:</span> <span class="n">unpackElse</span><span class="p">,</span>
                   <span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
                   <span class="s">&quot;tryCatch&quot;</span><span class="p">:</span> <span class="n">tryCatch</span><span class="p">,</span>
                   <span class="c"># Titus dependencies</span>
                   <span class="s">&quot;checkData&quot;</span><span class="p">:</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">checkData</span><span class="p">,</span>
                   <span class="c"># Python libraries</span>
                   <span class="s">&quot;math&quot;</span><span class="p">:</span> <span class="n">math</span><span class="p">,</span>
                   <span class="p">}</span>

        <span class="k">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">)</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&quot;__bases__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">PFAEngine</span><span class="p">,)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">parser</span>

        <span class="k">if</span> <span class="n">sharedState</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sharedState</span> <span class="o">=</span> <span class="n">SharedState</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cellName</span><span class="p">,</span> <span class="n">cellConfig</span> <span class="ow">in</span> <span class="n">engineConfig</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">shared</span> <span class="ow">and</span> <span class="n">cellName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sharedState</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">jsonDecoder</span><span class="p">(</span><span class="n">cellConfig</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">initJsonNode</span><span class="p">)</span>
                <span class="n">sharedState</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">cellName</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">rollback</span><span class="p">,</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">poolName</span><span class="p">,</span> <span class="n">poolConfig</span> <span class="ow">in</span> <span class="n">engineConfig</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">shared</span> <span class="ow">and</span> <span class="n">poolName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sharedState</span><span class="o">.</span><span class="n">pools</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">jsonDecoder</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroMap</span><span class="p">(</span><span class="n">poolConfig</span><span class="o">.</span><span class="n">avroType</span><span class="p">),</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">initJsonNode</span><span class="p">)</span>
                <span class="n">sharedState</span><span class="o">.</span><span class="n">pools</span><span class="p">[</span><span class="n">poolName</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">rollback</span><span class="p">,</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">multiplicity</span><span class="p">):</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sharedState</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
            <span class="n">pools</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sharedState</span><span class="o">.</span><span class="n">pools</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">cellName</span><span class="p">,</span> <span class="n">cellConfig</span> <span class="ow">in</span> <span class="n">engineConfig</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">jsonDecoder</span><span class="p">(</span><span class="n">cellConfig</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">initJsonNode</span><span class="p">)</span>
                    <span class="n">cells</span><span class="p">[</span><span class="n">cellName</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">rollback</span><span class="p">,</span> <span class="n">cellConfig</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">poolName</span><span class="p">,</span> <span class="n">poolConfig</span> <span class="ow">in</span> <span class="n">engineConfig</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">jsonDecoder</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroMap</span><span class="p">(</span><span class="n">poolConfig</span><span class="o">.</span><span class="n">avroType</span><span class="p">),</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">initJsonNode</span><span class="p">)</span>
                    <span class="n">pools</span><span class="p">[</span><span class="n">poolName</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">rollback</span><span class="p">,</span> <span class="n">poolConfig</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">engineConfig</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">FOLD</span><span class="p">:</span>
                <span class="n">zero</span> <span class="o">=</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">jsonDecoder</span><span class="p">(</span><span class="n">engineConfig</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">engineConfig</span><span class="o">.</span><span class="n">zero</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zero</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">engineConfig</span><span class="o">.</span><span class="n">randseed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">engineConfig</span><span class="o">.</span><span class="n">randseed</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">skip</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                    <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">engine</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="n">pools</span><span class="p">,</span> <span class="n">engineConfig</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">,</span> <span class="n">genericLog</span><span class="p">,</span> <span class="n">genericEmit</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rand</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">functionTable</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">engineConfig</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">EMIT</span><span class="p">:</span>
                <span class="n">f</span><span class="p">[</span><span class="s">&quot;emit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FakeEmitForExecution</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">engineConfig</span>

            <span class="n">checkForDeadlock</span><span class="p">(</span><span class="n">engineConfig</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="PFAEngine.fromJson"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.fromJson">[docs]</a>    <span class="k">def</span> <span class="nf">fromJson</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sharedState</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;pure&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PFAEngine</span><span class="o">.</span><span class="n">fromAst</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">jsonToAst</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">options</span><span class="p">,</span> <span class="n">sharedState</span><span class="p">,</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="PFAEngine.fromYaml"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.fromYaml">[docs]</a>    <span class="k">def</span> <span class="nf">fromYaml</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sharedState</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;pure&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PFAEngine</span><span class="o">.</span><span class="n">fromAst</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">yamlToAst</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">options</span><span class="p">,</span> <span class="n">sharedState</span><span class="p">,</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PFAEngine.snapshot"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newCells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">AstCell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">v</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">rollback</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">source</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">newPools</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">AstPool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pools</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="p">,</span> <span class="nb">dict</span><span class="p">((</span><span class="n">kk</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">vv</span><span class="p">))</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">v</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">rollback</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">source</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">EngineConfig</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">inputPlaceholder</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">outputPlaceholder</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fcns</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">zero</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span>
            <span class="n">newCells</span><span class="p">,</span>
            <span class="n">newPools</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">randseed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PFAEngine.calledBy"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.calledBy">[docs]</a>    <span class="k">def</span> <span class="nf">calledBy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcnName</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fcnName</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fcnName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callGraph</span><span class="p">:</span>
                <span class="n">newExclude</span> <span class="o">=</span> <span class="n">exclude</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">fcnName</span><span class="p">]))</span>
                <span class="n">nextLevel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callGraph</span><span class="p">[</span><span class="n">fcnName</span><span class="p">]:</span>
                    <span class="n">nextLevel</span> <span class="o">=</span> <span class="n">nextLevel</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calledBy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">newExclude</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callGraph</span><span class="p">[</span><span class="n">fcnName</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">nextLevel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PFAEngine.callDepth"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.callDepth">[docs]</a>    <span class="k">def</span> <span class="nf">callDepth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcnName</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">startingDepth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fcnName</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;inf&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fcnName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callGraph</span><span class="p">:</span>
                <span class="n">newExclude</span> <span class="o">=</span> <span class="n">exclude</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">fcnName</span><span class="p">]))</span>
                <span class="n">deepest</span> <span class="o">=</span> <span class="n">startingDepth</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callGraph</span><span class="p">[</span><span class="n">fcnName</span><span class="p">]:</span>
                    <span class="n">fdepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callDepth</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">newExclude</span><span class="p">,</span> <span class="n">startingDepth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fdepth</span> <span class="o">&gt;</span> <span class="n">deepest</span><span class="p">:</span>
                        <span class="n">deepest</span> <span class="o">=</span> <span class="n">fdepth</span>
                <span class="k">return</span> <span class="n">deepest</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">startingDepth</span>
</div>
<div class="viewcode-block" id="PFAEngine.isRecursive"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.isRecursive">[docs]</a>    <span class="k">def</span> <span class="nf">isRecursive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcnName</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fcnName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calledBy</span><span class="p">(</span><span class="n">fcnName</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PFAEngine.hasRecursive"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.hasRecursive">[docs]</a>    <span class="k">def</span> <span class="nf">hasRecursive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcnName</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callDepth</span><span class="p">(</span><span class="n">fcnName</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;inf&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PFAEngine.hasSideEffects"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.hasSideEffects">[docs]</a>    <span class="k">def</span> <span class="nf">hasSideEffects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcnName</span><span class="p">):</span>
        <span class="n">reach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calledBy</span><span class="p">(</span><span class="n">fcnName</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CellTo</span><span class="o">.</span><span class="n">desc</span> <span class="ow">in</span> <span class="n">reach</span> <span class="ow">or</span> <span class="n">PoolTo</span><span class="o">.</span><span class="n">desc</span> <span class="ow">in</span> <span class="n">reach</span>
</div>
<div class="viewcode-block" id="PFAEngine.avroInputIterator"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.avroInputIterator">[docs]</a>    <span class="k">def</span> <span class="nf">avroInputIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputStream</span><span class="p">,</span> <span class="n">interpreter</span><span class="o">=</span><span class="s">&quot;avro&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">interpreter</span> <span class="o">==</span> <span class="s">&quot;avro&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DataFileReader</span><span class="p">(</span><span class="n">inputStream</span><span class="p">,</span> <span class="n">DatumReader</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">interpreter</span> <span class="o">==</span> <span class="s">&quot;fastavro&quot;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">fastavro</span>
            <span class="k">return</span> <span class="n">fastavro</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">inputStream</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">interpreter</span> <span class="o">==</span> <span class="s">&quot;correct-fastavro&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FastAvroCorrector</span><span class="p">(</span><span class="n">inputStream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;interpreter must be one of </span><span class="se">\&quot;</span><span class="s">avro</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">fastavro</span><span class="se">\&quot;</span><span class="s">, and </span><span class="se">\&quot;</span><span class="s">correct-fastavro</span><span class="se">\&quot;</span><span class="s"> (which corrects fastavro&#39;s handling of Unicode strings)&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PFAEngine.avroOutputDataFileWriter"><a class="viewcode-back" href="../../titus.html#titus.genpy.PFAEngine.avroOutputDataFileWriter">[docs]</a>    <span class="k">def</span> <span class="nf">avroOutputDataFileWriter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DataFileWriter</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">),</span> <span class="n">DatumWriter</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="FastAvroCorrector"><a class="viewcode-back" href="../../titus.html#titus.genpy.FastAvroCorrector">[docs]</a><span class="k">class</span> <span class="nc">FastAvroCorrector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputStream</span><span class="p">,</span> <span class="n">avroType</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">fastavro</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">fastavro</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">inputStream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avroType</span> <span class="o">=</span> <span class="n">avroType</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="FastAvroCorrector.next"><a class="viewcode-back" href="../../titus.html#titus.genpy.FastAvroCorrector.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctFastAvro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FastAvroCorrector.correctFastAvro"><a class="viewcode-back" href="../../titus.html#titus.genpy.FastAvroCorrector.correctFastAvro">[docs]</a>    <span class="k">def</span> <span class="nf">correctFastAvro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">avroType</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroType</span><span class="p">,</span> <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroString</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroEnum</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s">&quot;replace&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroType</span><span class="p">,</span> <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroBytes</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroFixed</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s">&quot;replace&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroType</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroArray</span><span class="p">):</span>
            <span class="n">itemType</span> <span class="o">=</span> <span class="n">avroType</span><span class="o">.</span><span class="n">items</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctFastAvro</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">itemType</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroType</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroMap</span><span class="p">):</span>
            <span class="n">valueType</span> <span class="o">=</span> <span class="n">avroType</span><span class="o">.</span><span class="n">values</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s">&quot;replace&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctFastAvro</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">valueType</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroType</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroRecord</span><span class="p">):</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">avroType</span><span class="o">.</span><span class="n">fieldsDict</span>
            <span class="k">if</span> <span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;datum {0} does not match record schema</span><span class="se">\n</span><span class="s">{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">avroType</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctFastAvro</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">avroType</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroType</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroUnion</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">tpe</span> <span class="ow">in</span> <span class="n">avroType</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tpe</span><span class="p">,</span> <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroString</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroEnum</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tpe</span><span class="p">,</span> <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroBytes</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroFixed</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">))</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tpe</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroArray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)))</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tpe</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroMap</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctFastAvro</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tpe</span><span class="p">)</span>

                <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tpe</span><span class="p">,</span> <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroString</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroEnum</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">))</span> <span class="ow">or</span> \
                     <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tpe</span><span class="p">,</span> <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroBytes</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroFixed</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="n">x</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpe</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">AvroRecord</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctFastAvro</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tpe</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>   <span class="c"># this is the wrong record type; one of the later record types applies</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Titus 0.7.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Open Data Group.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>
