

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>titus.pfaast &mdash; Titus 0.7.1 documentation</title>
    
    <link rel="stylesheet" href="../../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../static/jquery.js"></script>
    <script type="text/javascript" src="../../static/underscore.js"></script>
    <script type="text/javascript" src="../../static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Titus 0.7.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Titus 0.7.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for titus.pfaast</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>

<span class="c"># Copyright (C) 2014  Open Data (&quot;Open Data&quot; refers to</span>
<span class="c"># one or more of the following companies: Open Data Partners LLC,</span>
<span class="c"># Open Data Research LLC, or Open Data Capital LLC.)</span>
<span class="c"># </span>
<span class="c"># This file is part of Hadrian.</span>
<span class="c"># </span>
<span class="c"># Licensed under the Hadrian Personal Use and Evaluation License (PUEL);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c"># </span>
<span class="c">#     http://raw.githubusercontent.com/opendatagroup/hadrian/master/LICENSE</span>
<span class="c"># </span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">titus.lib1.array</span>
<span class="kn">import</span> <span class="nn">titus.lib1.bytes</span>
<span class="kn">import</span> <span class="nn">titus.lib1.cast</span>
<span class="kn">import</span> <span class="nn">titus.lib1.core</span>
<span class="kn">import</span> <span class="nn">titus.lib1.enum</span>
<span class="kn">import</span> <span class="nn">titus.lib1.fixed</span>
<span class="kn">import</span> <span class="nn">titus.lib1.impute</span>
<span class="kn">import</span> <span class="nn">titus.lib1.interp</span>
<span class="kn">import</span> <span class="nn">titus.lib1.la</span>
<span class="kn">import</span> <span class="nn">titus.lib1.link</span>
<span class="kn">import</span> <span class="nn">titus.lib1.map</span>
<span class="kn">import</span> <span class="nn">titus.lib1.metric</span>
<span class="kn">import</span> <span class="nn">titus.lib1.pfamath</span>
<span class="kn">import</span> <span class="nn">titus.lib1.parse</span>
<span class="kn">import</span> <span class="nn">titus.lib1.pfastring</span>
<span class="kn">import</span> <span class="nn">titus.lib1.pfatest</span>
<span class="kn">import</span> <span class="nn">titus.lib1.pfatime</span>
<span class="kn">import</span> <span class="nn">titus.lib1.prob.dist</span>
<span class="kn">import</span> <span class="nn">titus.lib1.regex</span>
<span class="kn">import</span> <span class="nn">titus.lib1.rand</span>
<span class="kn">import</span> <span class="nn">titus.lib1.spec</span>
<span class="kn">import</span> <span class="nn">titus.lib1.stat.change</span>
<span class="kn">import</span> <span class="nn">titus.lib1.stat.sample</span>
<span class="kn">import</span> <span class="nn">titus.lib1.model.cluster</span>
<span class="kn">import</span> <span class="nn">titus.lib1.model.naive</span>
<span class="kn">import</span> <span class="nn">titus.lib1.model.neighbor</span>
<span class="kn">import</span> <span class="nn">titus.lib1.model.neural</span>
<span class="kn">import</span> <span class="nn">titus.lib1.model.tree</span>
<span class="kn">import</span> <span class="nn">titus.lib1.model.reg</span>

<span class="kn">import</span> <span class="nn">titus.P</span> <span class="kn">as</span> <span class="nn">P</span>
<span class="kn">import</span> <span class="nn">titus.util</span>

<span class="kn">from</span> <span class="nn">titus.errors</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">titus.fcn</span> <span class="kn">import</span> <span class="n">Fcn</span>
<span class="kn">from</span> <span class="nn">titus.signature</span> <span class="kn">import</span> <span class="n">IncompatibleTypes</span>
<span class="kn">from</span> <span class="nn">titus.signature</span> <span class="kn">import</span> <span class="n">LabelData</span>
<span class="kn">from</span> <span class="nn">titus.signature</span> <span class="kn">import</span> <span class="n">Sig</span>
<span class="kn">from</span> <span class="nn">titus.datatype</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">titus.options</span>
<span class="kn">from</span> <span class="nn">titus.util</span> <span class="kn">import</span> <span class="n">ts</span>

<span class="c">############################################################ utils</span>

<div class="viewcode-block" id="inferType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.inferType">[docs]</a><span class="k">def</span> <span class="nf">inferType</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pools</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fcns</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">symbols</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">cells</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">pools</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">fcns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fcns</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">symbolTable</span> <span class="o">=</span> <span class="n">SymbolTable</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">pools</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">functionTable</span> <span class="o">=</span> <span class="n">FunctionTable</span><span class="o">.</span><span class="n">blank</span><span class="p">()</span>
    <span class="n">functionTable</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fcns</span><span class="p">)</span>

    <span class="n">context</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">NoTask</span><span class="p">(),</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">titus</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">EngineOptions</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">retType</span>

<span class="c">############################################################ symbols</span>
</div>
<div class="viewcode-block" id="validSymbolName"><a class="viewcode-back" href="../../titus.html#titus.pfaast.validSymbolName">[docs]</a><span class="k">def</span> <span class="nf">validSymbolName</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^[A-Za-z_][A-Za-z0-9_]*$&quot;</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="SymbolTable"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable">[docs]</a><span class="k">class</span> <span class="nc">SymbolTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">pools</span><span class="p">,</span> <span class="n">sealedAbove</span><span class="p">,</span> <span class="n">sealedWithin</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="n">cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pools</span> <span class="o">=</span> <span class="n">pools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sealedAbove</span> <span class="o">=</span> <span class="n">sealedAbove</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sealedWithin</span> <span class="o">=</span> <span class="n">sealedWithin</span>

<div class="viewcode-block" id="SymbolTable.getLocal"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.getLocal">[docs]</a>    <span class="k">def</span> <span class="nf">getLocal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="SymbolTable.getAbove"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.getAbove">[docs]</a>    <span class="k">def</span> <span class="nf">getAbove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SymbolTable.get"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLocal</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAbove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;no symbol named </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="SymbolTable.writable"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.writable">[docs]</a>    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sealedWithin</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sealedAbove</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;no symbol named </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">writable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SymbolTable.put"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">avroType</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">avroType</span>
</div>
<div class="viewcode-block" id="SymbolTable.cell"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.cell">[docs]</a>    <span class="k">def</span> <span class="nf">cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="SymbolTable.pool"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.pool">[docs]</a>    <span class="k">def</span> <span class="nf">pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        </div>
<div class="viewcode-block" id="SymbolTable.newScope"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.newScope">[docs]</a>    <span class="k">def</span> <span class="nf">newScope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sealedAbove</span><span class="p">,</span> <span class="n">sealedWithin</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SymbolTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="n">sealedAbove</span><span class="p">,</span> <span class="n">sealedWithin</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="SymbolTable.inThisScope"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.inThisScope">[docs]</a>    <span class="k">def</span> <span class="nf">inThisScope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="SymbolTable.allInScope"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.allInScope">[docs]</a>    <span class="k">def</span> <span class="nf">allInScope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">allInScope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="SymbolTable.blank"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SymbolTable.blank">[docs]</a>    <span class="k">def</span> <span class="nf">blank</span><span class="p">():</span>
        <span class="n">SymbolTable</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

<span class="c">############################################################ functions</span>
</div></div>
<div class="viewcode-block" id="validFunctionName"><a class="viewcode-back" href="../../titus.html#titus.pfaast.validFunctionName">[docs]</a><span class="k">def</span> <span class="nf">validFunctionName</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^[A-Za-z_]([A-Za-z0-9_]|</span><span class="se">\\</span><span class="s">.[A-Za-z][A-Za-z0-9_]*)*$&quot;</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="UserFcn"><a class="viewcode-back" href="../../titus.html#titus.pfaast.UserFcn">[docs]</a><span class="k">class</span> <span class="nc">UserFcn</span><span class="p">(</span><span class="n">Fcn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span>

<div class="viewcode-block" id="UserFcn.genpy"><a class="viewcode-back" href="../../titus.html#titus.pfaast.UserFcn.genpy">[docs]</a>    <span class="k">def</span> <span class="nf">genpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramTypes</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">parNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">params</span><span class="p">]</span>
        <span class="k">return</span> <span class="s">&quot;call(state, DynamicScope(None), self.f[&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;], {&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parNames</span><span class="p">,</span> <span class="n">args</span><span class="p">)])</span> <span class="o">+</span> <span class="s">&quot;})&quot;</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="UserFcn.fromFcnDef"><a class="viewcode-back" href="../../titus.html#titus.pfaast.UserFcn.fromFcnDef">[docs]</a>    <span class="k">def</span> <span class="nf">fromFcnDef</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fcnDef</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">UserFcn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Sig</span><span class="p">([{</span><span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">P</span><span class="o">.</span><span class="n">fromType</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">fcnDef</span><span class="o">.</span><span class="n">params</span><span class="p">],</span> <span class="n">P</span><span class="o">.</span><span class="n">fromType</span><span class="p">(</span><span class="n">fcnDef</span><span class="o">.</span><span class="n">ret</span><span class="p">)))</span>
</div></div>
<div class="viewcode-block" id="EmitFcn"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EmitFcn">[docs]</a><span class="k">class</span> <span class="nc">EmitFcn</span><span class="p">(</span><span class="n">Fcn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputType</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">Sig</span><span class="p">([{</span><span class="s">&quot;output&quot;</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">fromType</span><span class="p">(</span><span class="n">outputType</span><span class="p">)}],</span> <span class="n">P</span><span class="o">.</span><span class="n">Null</span><span class="p">())</span>

<div class="viewcode-block" id="EmitFcn.genpy"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EmitFcn.genpy">[docs]</a>    <span class="k">def</span> <span class="nf">genpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramTypes</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;self.f[</span><span class="se">\&quot;</span><span class="s">emit</span><span class="se">\&quot;</span><span class="s">].engine.emit(&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
</div></div>
<div class="viewcode-block" id="FunctionTable"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FunctionTable">[docs]</a><span class="k">class</span> <span class="nc">FunctionTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">functions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="n">functions</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="FunctionTable.blank"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FunctionTable.blank">[docs]</a>    <span class="k">def</span> <span class="nf">blank</span><span class="p">():</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">bytes</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">cast</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">enum</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">fixed</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">impute</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">la</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">pfamath</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">prob</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">pfastring</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">rand</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">change</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">pfatest</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">pfatime</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">naive</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">neural</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">lib1</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>

        <span class="c"># TODO: functions.update(titus.lib1.other.provides)...</span>

        <span class="k">return</span> <span class="n">FunctionTable</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span>

<span class="c">############################################################ type-checking and transforming ASTs</span>
</div></div>
<div class="viewcode-block" id="AstContext"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AstContext">[docs]</a><span class="k">class</span> <span class="nc">AstContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="ArgumentContext"><a class="viewcode-back" href="../../titus.html#titus.pfaast.ArgumentContext">[docs]</a><span class="k">class</span> <span class="nc">ArgumentContext</span><span class="p">(</span><span class="n">AstContext</span><span class="p">):</span>
<div class="viewcode-block" id="ArgumentContext.calls"><a class="viewcode-back" href="../../titus.html#titus.pfaast.ArgumentContext.calls">[docs]</a>    <span class="k">def</span> <span class="nf">calls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>
<div class="viewcode-block" id="ExpressionContext"><a class="viewcode-back" href="../../titus.html#titus.pfaast.ExpressionContext">[docs]</a><span class="k">class</span> <span class="nc">ExpressionContext</span><span class="p">(</span><span class="n">ArgumentContext</span><span class="p">):</span>
<div class="viewcode-block" id="ExpressionContext.retType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.ExpressionContext.retType">[docs]</a>    <span class="k">def</span> <span class="nf">retType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>
<div class="viewcode-block" id="FcnContext"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnContext">[docs]</a><span class="k">class</span> <span class="nc">FcnContext</span><span class="p">(</span><span class="n">ArgumentContext</span><span class="p">):</span>
<div class="viewcode-block" id="FcnContext.fcnType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnContext.fcnType">[docs]</a>    <span class="k">def</span> <span class="nf">fcnType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>
<div class="viewcode-block" id="TaskResult"><a class="viewcode-back" href="../../titus.html#titus.pfaast.TaskResult">[docs]</a><span class="k">class</span> <span class="nc">TaskResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Task"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Task">[docs]</a><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">astContext</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">,</span> <span class="n">resoledType</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="NoTask"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NoTask">[docs]</a><span class="k">class</span> <span class="nc">NoTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<div class="viewcode-block" id="NoTask.EmptyResult"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NoTask.EmptyResult">[docs]</a>    <span class="k">class</span> <span class="nc">EmptyResult</span><span class="p">(</span><span class="n">TaskResult</span><span class="p">):</span> <span class="k">pass</span></div>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">astContext</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">,</span> <span class="n">resolvedType</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmptyResult</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="check"><a class="viewcode-back" href="../../titus.html#titus.pfaast.check">[docs]</a><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">engineConfig</span><span class="p">):</span>
    <span class="n">engineConfig</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">NoTask</span><span class="p">(),</span>
                      <span class="n">SymbolTable</span><span class="o">.</span><span class="n">blank</span><span class="p">(),</span>
                      <span class="n">FunctionTable</span><span class="o">.</span><span class="n">blank</span><span class="p">(),</span>
                      <span class="n">titus</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">EngineOptions</span><span class="p">(</span><span class="n">engineConfig</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="isValid"><a class="viewcode-back" href="../../titus.html#titus.pfaast.isValid">[docs]</a><span class="k">def</span> <span class="nf">isValid</span><span class="p">(</span><span class="n">engineConfig</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">check</span><span class="p">(</span><span class="n">engineConfig</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">PFASyntaxException</span><span class="p">,</span> <span class="n">PFASemanticException</span><span class="p">,</span> <span class="n">PFAInitializationException</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="c">############################################################ AST nodes</span>
</div>
<div class="viewcode-block" id="Ast"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ast">[docs]</a><span class="k">class</span> <span class="nc">Ast</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="Ast.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ast.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="Ast.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ast.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Ast.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ast.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">functionTable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">engineOptions</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbolTable</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">functionTable</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">engineOptions</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">SymbolTable</span><span class="o">.</span><span class="n">blank</span><span class="p">(),</span> <span class="n">FunctionTable</span><span class="o">.</span><span class="n">blank</span><span class="p">(),</span> <span class="n">titus</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">EngineOptions</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="Ast.toJson"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ast.toJson">[docs]</a>    <span class="k">def</span> <span class="nf">toJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="nb">set</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="Ast.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ast.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="Ast.startDict"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ast.startDict">[docs]</a>    <span class="k">def</span> <span class="nf">startDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lineNumbers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s">&quot;@&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="Subs"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Subs">[docs]</a><span class="k">class</span> <span class="nc">Subs</span><span class="p">(</span><span class="n">Ast</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="s">&quot;Substitution at line &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="n">lineno</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">lineno</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">lineno</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="Subs.asExpr"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Subs.asExpr">[docs]</a>    <span class="k">def</span> <span class="nf">asExpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="s">&quot;expr&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Subs.asType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Subs.asType">[docs]</a>    <span class="k">def</span> <span class="nf">asType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="s">&quot;type&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Subs.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Subs.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">functionTable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">engineOptions</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;Unresolved substitution </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Subs.toJson"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Subs.toJson">[docs]</a>    <span class="k">def</span> <span class="nf">toJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;Unresolved substitution </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Subs.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Subs.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;&lt;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;&gt;&gt;&quot;</span>
        </div>
<div class="viewcode-block" id="Method"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Method">[docs]</a><span class="k">class</span> <span class="nc">Method</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">MAP</span> <span class="o">=</span> <span class="s">&quot;map&quot;</span>
    <span class="n">EMIT</span> <span class="o">=</span> <span class="s">&quot;emit&quot;</span>
    <span class="n">FOLD</span> <span class="o">=</span> <span class="s">&quot;fold&quot;</span>
</div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="EngineConfig"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EngineConfig">[docs]</a><span class="k">class</span> <span class="nc">EngineConfig</span><span class="p">(</span><span class="n">Ast</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span>
                 <span class="n">method</span><span class="p">,</span>
                 <span class="n">inputPlaceholder</span><span class="p">,</span>
                 <span class="n">outputPlaceholder</span><span class="p">,</span>
                 <span class="n">begin</span><span class="p">,</span>
                 <span class="n">action</span><span class="p">,</span>
                 <span class="n">end</span><span class="p">,</span>
                 <span class="n">fcns</span><span class="p">,</span>
                 <span class="n">zero</span><span class="p">,</span>
                 <span class="n">merge</span><span class="p">,</span>
                 <span class="n">cells</span><span class="p">,</span>
                 <span class="n">pools</span><span class="p">,</span>
                 <span class="n">randseed</span><span class="p">,</span>
                 <span class="n">doc</span><span class="p">,</span>
                 <span class="n">version</span><span class="p">,</span>
                 <span class="n">metadata</span><span class="p">,</span>
                 <span class="n">options</span><span class="p">,</span>
                 <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Method</span><span class="o">.</span><span class="n">MAP</span><span class="p">,</span> <span class="n">Method</span><span class="o">.</span><span class="n">EMIT</span><span class="p">,</span> <span class="n">Method</span><span class="o">.</span><span class="n">FOLD</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">method</span><span class="se">\&quot;</span><span class="s"> must be </span><span class="se">\&quot;</span><span class="s">map</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">emit</span><span class="se">\&quot;</span><span class="s">, or </span><span class="se">\&quot;</span><span class="s">fold</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">inputPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">outputPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">begin</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">begin</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">action</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">action</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">end</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">end</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fcns</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">FcnDef</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fcns</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">fcns</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of FcnDefs&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zero</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">zero</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">merge</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">merge</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">merge</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">merge</span><span class="se">\&quot;</span><span class="s"> must be list of Expressions or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cells</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">cells</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of Cells&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pools</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Pool</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pools</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pools</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of Pools&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">randseed</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">randseed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">randseed</span><span class="se">\&quot;</span><span class="s"> must be an int or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">doc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">doc</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">version</span><span class="se">\&quot;</span><span class="s"> must be an int or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">metadata</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of strings&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">options</span><span class="se">\&quot;</span><span class="s"> must be a dictionary&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">action</span><span class="se">\&quot;</span><span class="s"> must contain least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">FOLD</span> <span class="ow">and</span> <span class="p">(</span><span class="n">zero</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">merge</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;folding engines must include </span><span class="se">\&quot;</span><span class="s">zero</span><span class="se">\&quot;</span><span class="s"> and </span><span class="se">\&quot;</span><span class="s">merge</span><span class="se">\&quot;</span><span class="s"> top-level fields&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="n">Method</span><span class="o">.</span><span class="n">FOLD</span> <span class="ow">and</span> <span class="p">(</span><span class="n">zero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">merge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;non-folding engines must not include </span><span class="se">\&quot;</span><span class="s">zero</span><span class="se">\&quot;</span><span class="s"> and </span><span class="se">\&quot;</span><span class="s">merge</span><span class="se">\&quot;</span><span class="s"> top-level fields&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">merge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">merge</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">merge</span><span class="se">\&quot;</span><span class="s"> must contain least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="EngineConfig.toString"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EngineConfig.toString">[docs]</a>    <span class="k">def</span> <span class="nf">toString</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;&#39;EngineConfig(name={name},</span>
<span class="s">    method={method},</span>
<span class="s">    inputPlaceholder={inputPlaceholder},</span>
<span class="s">    outputPlaceholder={outputPlaceholder},</span>
<span class="s">    begin={begin},</span>
<span class="s">    action={action},</span>
<span class="s">    end={end},</span>
<span class="s">    fcns={fcns},</span>
<span class="s">    zero={zero},</span>
<span class="s">    merge={merge},</span>
<span class="s">    cells={cells},</span>
<span class="s">    pools={pools},</span>
<span class="s">    randseed={randseed},</span>
<span class="s">    doc={doc},</span>
<span class="s">    version={version},</span>
<span class="s">    metadata={metadata},</span>
<span class="s">    options={options})&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                         <span class="n">inputPlaceholder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputPlaceholder</span><span class="p">,</span>
                         <span class="n">outputPlaceholder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outputPlaceholder</span><span class="p">,</span>
                         <span class="n">begin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span>
                         <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                         <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                         <span class="n">fcns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fcns</span><span class="p">,</span>
                         <span class="n">zero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zero</span><span class="p">,</span>
                         <span class="n">merge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span>
                         <span class="n">cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">,</span>
                         <span class="n">pools</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">,</span>
                         <span class="n">randseed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">randseed</span><span class="p">,</span>
                         <span class="n">doc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span>
                         <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                         <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                         <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="EngineConfig.input"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EngineConfig.input">[docs]</a>    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="EngineConfig.output"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EngineConfig.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
<div class="viewcode-block" id="EngineConfig.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EngineConfig.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">EngineConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcns</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="EngineConfig.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EngineConfig.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EngineConfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inputPlaceholder</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">outputPlaceholder</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">],</span>
                                <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcns</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">zero</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span>
                                <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                                <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">randseed</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EngineConfig.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EngineConfig.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">topWrapper</span> <span class="o">=</span> <span class="n">SymbolTable</span><span class="p">(</span><span class="n">symbolTable</span><span class="p">,</span> <span class="p">{},</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">userFunctions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fcnDef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ufname</span> <span class="o">=</span> <span class="s">&quot;u.&quot;</span> <span class="o">+</span> <span class="n">fname</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validFunctionName</span><span class="p">(</span><span class="n">ufname</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid function name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">userFunctions</span><span class="p">[</span><span class="n">ufname</span><span class="p">]</span> <span class="o">=</span> <span class="n">UserFcn</span><span class="o">.</span><span class="n">fromFcnDef</span><span class="p">(</span><span class="n">ufname</span><span class="p">,</span> <span class="n">fcnDef</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">EMIT</span><span class="p">:</span>
            <span class="n">emitFcn</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;emit&quot;</span><span class="p">:</span> <span class="n">EmitFcn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">emitFcn</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">withUserFunctions</span> <span class="o">=</span> <span class="n">FunctionTable</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">functionTable</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">userFunctions</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">emitFcn</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>

        <span class="n">userFcnContexts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fcnDef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ufname</span> <span class="o">=</span> <span class="s">&quot;u.&quot;</span> <span class="o">+</span> <span class="n">fname</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">topWrapper</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">fcnContext</span><span class="p">,</span> <span class="n">fcnResult</span> <span class="o">=</span> <span class="n">fcnDef</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">withUserFunctions</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
            <span class="n">userFcnContexts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ufname</span><span class="p">,</span> <span class="n">fcnContext</span><span class="p">))</span>

        <span class="n">beginScopeWrapper</span> <span class="o">=</span> <span class="n">topWrapper</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">beginScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">AvroString</span><span class="p">())</span>
        <span class="n">beginScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span> <span class="n">AvroInt</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">beginScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="n">AvroInt</span><span class="p">())</span>
        <span class="n">beginScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;metadata&quot;</span><span class="p">,</span> <span class="n">AvroMap</span><span class="p">(</span><span class="n">AvroString</span><span class="p">()))</span>
        <span class="n">beginScope</span> <span class="o">=</span> <span class="n">beginScopeWrapper</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">beginContextResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">beginScope</span><span class="p">,</span> <span class="n">withUserFunctions</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">]</span>
        <span class="n">beginResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">beginContextResults</span><span class="p">]</span>
        <span class="n">beginCalls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calls</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">beginContextResults</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mergeScopeWrapper</span> <span class="o">=</span> <span class="n">topWrapper</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">mergeScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;tallyOne&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="n">mergeScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;tallyTwo&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="n">mergeScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">AvroString</span><span class="p">())</span>
            <span class="n">mergeScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span> <span class="n">AvroInt</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">mergeScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="n">AvroInt</span><span class="p">())</span>
            <span class="n">mergeScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;metadata&quot;</span><span class="p">,</span> <span class="n">AvroMap</span><span class="p">(</span><span class="n">AvroString</span><span class="p">()))</span>
            <span class="n">mergeScope</span> <span class="o">=</span> <span class="n">mergeScopeWrapper</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

            <span class="n">mergeContextResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">mergeScope</span><span class="p">,</span> <span class="n">withUserFunctions</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">]</span>
            <span class="n">mergeCalls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calls</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mergeContextResults</span><span class="p">]))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">mergeContextResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;merge&#39;s inferred output type is {0} but the declared output type is {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">mergeContextResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">mergeOption</span> <span class="o">=</span> <span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mergeContextResults</span><span class="p">],</span>
                           <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mergeScopeWrapper</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">mergeScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
                           <span class="n">mergeCalls</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mergeOption</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># this will go into end and action, but not begin or merge</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">FOLD</span><span class="p">:</span>
            <span class="n">topWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;tally&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

        <span class="n">endScopeWrapper</span> <span class="o">=</span> <span class="n">topWrapper</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">endScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">AvroString</span><span class="p">())</span>
        <span class="n">endScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span> <span class="n">AvroInt</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">endScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="n">AvroInt</span><span class="p">())</span>
        <span class="n">endScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;metadata&quot;</span><span class="p">,</span> <span class="n">AvroMap</span><span class="p">(</span><span class="n">AvroString</span><span class="p">()))</span>
        <span class="n">endScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;actionsStarted&quot;</span><span class="p">,</span> <span class="n">AvroLong</span><span class="p">())</span>
        <span class="n">endScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;actionsFinished&quot;</span><span class="p">,</span> <span class="n">AvroLong</span><span class="p">())</span>
        <span class="n">endScope</span> <span class="o">=</span> <span class="n">endScopeWrapper</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">endContextResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">endScope</span><span class="p">,</span> <span class="n">withUserFunctions</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">]</span>
        <span class="n">endResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">endContextResults</span><span class="p">]</span>
        <span class="n">endCalls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calls</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">endContextResults</span><span class="p">]))</span>

        <span class="n">actionScopeWrapper</span> <span class="o">=</span> <span class="n">topWrapper</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">actionScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="n">actionScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">AvroString</span><span class="p">())</span>
        <span class="n">actionScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span> <span class="n">AvroInt</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">actionScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="n">AvroInt</span><span class="p">())</span>
        <span class="n">actionScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;metadata&quot;</span><span class="p">,</span> <span class="n">AvroMap</span><span class="p">(</span><span class="n">AvroString</span><span class="p">()))</span>
        <span class="n">actionScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;actionsStarted&quot;</span><span class="p">,</span> <span class="n">AvroLong</span><span class="p">())</span>
        <span class="n">actionScopeWrapper</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;actionsFinished&quot;</span><span class="p">,</span> <span class="n">AvroLong</span><span class="p">())</span>
        <span class="n">actionScope</span> <span class="o">=</span> <span class="n">actionScopeWrapper</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">actionContextResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">actionScope</span><span class="p">,</span> <span class="n">withUserFunctions</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">]</span>
        <span class="n">actionCalls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calls</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">actionContextResults</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">MAP</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">FOLD</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">actionContextResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;action&#39;s inferred output type is {0} but the declared output type is {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">actionContextResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputPlaceholder</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">compiledTypes</span><span class="p">,</span>
            <span class="p">(</span><span class="n">beginResults</span><span class="p">,</span>
             <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">beginScopeWrapper</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">beginScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
             <span class="n">beginCalls</span><span class="p">),</span>
            <span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">actionContextResults</span><span class="p">],</span>
             <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">actionScopeWrapper</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">actionScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
             <span class="n">actionCalls</span><span class="p">),</span>
            <span class="p">(</span><span class="n">endResults</span><span class="p">,</span>
             <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">endScopeWrapper</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">endScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
             <span class="n">endCalls</span><span class="p">),</span>
            <span class="n">userFcnContexts</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero</span><span class="p">,</span>
            <span class="n">mergeOption</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">randseed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputPlaceholder</span><span class="o">.</span><span class="n">parser</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EngineConfig.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EngineConfig.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;begin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">]</span>

        <span class="n">out</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;fcns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcns</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;pools&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;zero&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;merge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randseed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;randseed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">randseed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;doc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="EngineConfig.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.EngineConfig.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">AstContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">name</span><span class="p">,</span>
                     <span class="n">method</span><span class="p">,</span>
                     <span class="nb">input</span><span class="p">,</span>
                     <span class="n">output</span><span class="p">,</span>
                     <span class="n">compiledTypes</span><span class="p">,</span>
                     <span class="n">begin</span><span class="p">,</span>
                     <span class="n">action</span><span class="p">,</span>
                     <span class="n">end</span><span class="p">,</span>
                     <span class="n">fcns</span><span class="p">,</span>
                     <span class="n">zero</span><span class="p">,</span>
                     <span class="n">merge</span><span class="p">,</span>
                     <span class="n">cells</span><span class="p">,</span>
                     <span class="n">pools</span><span class="p">,</span>
                     <span class="n">randseed</span><span class="p">,</span>
                     <span class="n">doc</span><span class="p">,</span>
                     <span class="n">version</span><span class="p">,</span>
                     <span class="n">metadata</span><span class="p">,</span>
                     <span class="n">options</span><span class="p">,</span>
                     <span class="n">parser</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<div class="viewcode-block" id="CellPoolSource"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellPoolSource">[docs]</a><span class="k">class</span> <span class="nc">CellPoolSource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">EMBEDDED</span> <span class="o">=</span> <span class="s">&quot;embedded&quot;</span>
    <span class="n">JSON</span> <span class="o">=</span> <span class="s">&quot;json&quot;</span>
    <span class="n">AVRO</span> <span class="o">=</span> <span class="s">&quot;avro&quot;</span>
</div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Cell"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cell">[docs]</a><span class="k">class</span> <span class="nc">Cell</span><span class="p">(</span><span class="n">Ast</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avroPlaceholder</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">rollback</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">avroPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">init</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">init</span><span class="se">\&quot;</span><span class="s"> must be a string or callable&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shared</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">shared</span><span class="se">\&quot;</span><span class="s"> must be boolean&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rollback</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">rollback</span><span class="se">\&quot;</span><span class="s"> must be boolean&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">source</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">source</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">shared</span> <span class="ow">and</span> <span class="n">rollback</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;shared and rollback are mutually incompatible flags for a Cell&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Cell.equals"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cell.equals">[docs]</a>    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Cell</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">avroPlaceholder</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">initJsonNode</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">initJsonNode</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">shared</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">rollback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">source</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Cell.avroType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cell.avroType">[docs]</a>    <span class="k">def</span> <span class="nf">avroType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
<div class="viewcode-block" id="Cell.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cell.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Cell.initJsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cell.initJsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">initJsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Cell.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cell.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initJsonNode</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;shared&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;rollback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">!=</span> <span class="n">CellPoolSource</span><span class="o">.</span><span class="n">EMBEDDED</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Cell.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cell.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">AstContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Pool"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pool">[docs]</a><span class="k">class</span> <span class="nc">Pool</span><span class="p">(</span><span class="n">Ast</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avroPlaceholder</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">rollback</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">avroPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">init</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">init</span><span class="se">\&quot;</span><span class="s"> must be a string or callable&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shared</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">shared</span><span class="se">\&quot;</span><span class="s"> must be boolean&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rollback</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">rollback</span><span class="se">\&quot;</span><span class="s"> must be boolean&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">source</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">source</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shared</span> <span class="ow">and</span> <span class="n">rollback</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;shared and rollback are mutually incompatible flags for a Pool&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Pool.equals"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pool.equals">[docs]</a>    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Pool</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">avroPlaceholder</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">initJsonNode</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">initJsonNode</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">shared</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">rollback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">source</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Pool.avroType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pool.avroType">[docs]</a>    <span class="k">def</span> <span class="nf">avroType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
<div class="viewcode-block" id="Pool.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pool.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Pool.initJsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pool.initJsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">initJsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">AvroMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Pool.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pool.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initJsonNode</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;shared&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;rollback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">!=</span> <span class="n">CellPoolSource</span><span class="o">.</span><span class="n">EMBEDDED</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="k">return</span> <span class="n">out</span>
            </div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Pool.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pool.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">AstContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<div class="viewcode-block" id="Argument"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Argument">[docs]</a><span class="k">class</span> <span class="nc">Argument</span><span class="p">(</span><span class="n">Ast</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="Expression"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Expression">[docs]</a><span class="k">class</span> <span class="nc">Expression</span><span class="p">(</span><span class="n">Argument</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="LiteralValue"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralValue">[docs]</a><span class="k">class</span> <span class="nc">LiteralValue</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span> <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PathIndex"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PathIndex">[docs]</a><span class="k">class</span> <span class="nc">PathIndex</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="k">pass</span></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="ArrayIndex"><a class="viewcode-back" href="../../titus.html#titus.pfaast.ArrayIndex">[docs]</a><span class="k">class</span> <span class="nc">ArrayIndex</span><span class="p">(</span><span class="n">PathIndex</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="k">pass</span></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="MapIndex"><a class="viewcode-back" href="../../titus.html#titus.pfaast.MapIndex">[docs]</a><span class="k">class</span> <span class="nc">MapIndex</span><span class="p">(</span><span class="n">PathIndex</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="k">pass</span></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="RecordIndex"><a class="viewcode-back" href="../../titus.html#titus.pfaast.RecordIndex">[docs]</a><span class="k">class</span> <span class="nc">RecordIndex</span><span class="p">(</span><span class="n">PathIndex</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="k">pass</span>
</div>
<div class="viewcode-block" id="HasPath"><a class="viewcode-back" href="../../titus.html#titus.pfaast.HasPath">[docs]</a><span class="k">class</span> <span class="nc">HasPath</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="HasPath.walkPath"><a class="viewcode-back" href="../../titus.html#titus.pfaast.HasPath.walkPath">[docs]</a>    <span class="k">def</span> <span class="nf">walkPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avroType</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">walkingType</span> <span class="o">=</span> <span class="n">avroType</span>

        <span class="n">pathIndexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">indexIndex</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">walkingType</span><span class="p">,</span> <span class="n">AvroArray</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroLong</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroInt</span><span class="p">):</span>
                    <span class="n">walkingType</span> <span class="o">=</span> <span class="n">walkingType</span><span class="o">.</span><span class="n">items</span>
                    <span class="n">pathIndexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ArrayIndex</span><span class="p">(</span><span class="n">exprResult</span><span class="p">,</span> <span class="n">walkingType</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;path index for an array must resolve to a long or int; item {0} is a {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexIndex</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">walkingType</span><span class="p">,</span> <span class="n">AvroMap</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroString</span><span class="p">):</span>
                    <span class="n">walkingType</span> <span class="o">=</span> <span class="n">walkingType</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">pathIndexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MapIndex</span><span class="p">(</span><span class="n">exprResult</span><span class="p">,</span> <span class="n">walkingType</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;path index for a map must resolve to a string; item {0} is a {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexIndex</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">walkingType</span><span class="p">,</span> <span class="n">AvroRecord</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroString</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="p">,</span> <span class="n">LiteralString</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="p">,</span> <span class="n">Literal</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroString</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;path index for record {0} must be a literal string; item {1} is an object of type {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">walkingType</span><span class="p">),</span> <span class="n">indexIndex</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">walkingType</span><span class="o">.</span><span class="n">fieldsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">walkingType</span> <span class="o">=</span> <span class="n">walkingType</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">avroType</span>
                        <span class="n">pathIndexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RecordIndex</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">walkingType</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;record {0} has no field named </span><span class="se">\&quot;</span><span class="s">{1}</span><span class="se">\&quot;</span><span class="s"> (path index {2})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">walkingType</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">indexIndex</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;path index for a record must be a string; item {0} is a {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexIndex</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;path item {0} is a {1}, which cannot be indexed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexIndex</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">walkingType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">walkingType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">pathIndexes</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="FcnDef"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef">[docs]</a><span class="k">class</span> <span class="nc">FcnDef</span><span class="p">(</span><span class="n">Argument</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramsPlaceholder</span><span class="p">,</span> <span class="n">retPlaceholder</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paramsPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">paramsPlaceholder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">paramsPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be a list of single-key dictionaries of AvroPlaceholders or AvroTypes&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">retPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">body</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;function&#39;s </span><span class="se">\&quot;</span><span class="s">do</span><span class="se">\&quot;</span><span class="s"> list must contain least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="FcnDef.paramNames"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef.paramNames">[docs]</a>    <span class="k">def</span> <span class="nf">paramNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramsPlaceholder</span><span class="p">]</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="FcnDef.params"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef.params">[docs]</a>    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[{</span><span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">avroType</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramsPlaceholder</span><span class="p">]</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="FcnDef.paramsDict"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef.paramsDict">[docs]</a>    <span class="k">def</span> <span class="nf">paramsDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">avroType</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramsPlaceholder</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="FcnDef.ret"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef.ret">[docs]</a>    <span class="k">def</span> <span class="nf">ret</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
<div class="viewcode-block" id="FcnDef.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">FcnDef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FcnDef.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FcnDef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paramsPlaceholder</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">retPlaceholder</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FcnDef.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paramsPlaceholder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;function can have at most 22 parameters&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">avroType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramsDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validSymbolName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid parameter name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">scope</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">avroType</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>

        <span class="n">inferredRetType</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inferredRetType</span><span class="p">,</span> <span class="n">ExceptionType</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ret</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">inferredRetType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;function&#39;s inferred return type is {0} but its declared return type is {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ret</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">FcnType</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ret</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calls</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramNames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramsDict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ret</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FcnDef.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramsPlaceholder</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;ret&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;do&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="FcnDef.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnDef.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">FcnContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcnType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">paramNames</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">exprs</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="FcnRef"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRef">[docs]</a><span class="k">class</span> <span class="nc">FcnRef</span><span class="p">(</span><span class="n">Argument</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="FcnRef.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRef.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">fcn</span> <span class="o">=</span> <span class="n">functionTable</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fcn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;unknown function </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> (be sure to include </span><span class="se">\&quot;</span><span class="s">u.</span><span class="se">\&quot;</span><span class="s"> to reference user functions)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fcn</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="n">Sig</span><span class="p">):</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">fcn</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">fcn</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">ret</span>
                <span class="n">fcnType</span> <span class="o">=</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">P</span><span class="o">.</span><span class="n">toType</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">],</span> <span class="n">P</span><span class="o">.</span><span class="n">mustBeAvro</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">toType</span><span class="p">(</span><span class="n">ret</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IncompatibleTypes</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">IncompatibleTypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;only one-signature functions without constraints can be referenced (wrap </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> in a function definition with the desired signature)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">FcnRef</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">fcnType</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]),</span> <span class="n">fcn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FcnRef.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRef.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;fcn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="FcnRef.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRef.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">FcnContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcnType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">fcn</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="FcnRefFill"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRefFill">[docs]</a><span class="k">class</span> <span class="nc">FcnRefFill</span><span class="p">(</span><span class="n">Argument</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Argument</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fill</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">fill</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of Arguments&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">fill</span><span class="se">\&quot;</span><span class="s"> must contain at least one parameter name-argument mapping&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="FcnRefFill.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRefFill.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">FcnRefFill</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="FcnRefFill.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRefFill.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FcnRefFill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FcnRefFill.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRefFill.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

        <span class="n">fcn</span> <span class="o">=</span> <span class="n">functionTable</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fcn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;unknown function </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> (be sure to include </span><span class="se">\&quot;</span><span class="s">u.</span><span class="se">\&quot;</span><span class="s"> to reference user functions)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">fillScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">argTypeResult</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">argCtx</span><span class="p">,</span> <span class="n">argRes</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">fillScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">argCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argCtx</span><span class="p">,</span> <span class="n">FcnContext</span><span class="p">):</span>
                <span class="n">argTypeResult</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">argCtx</span><span class="o">.</span><span class="n">fcnType</span><span class="p">,</span> <span class="n">argRes</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argCtx</span><span class="p">,</span> <span class="n">ExpressionContext</span><span class="p">):</span>
                <span class="n">argTypeResult</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">argCtx</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">argRes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fcn</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="n">Sig</span><span class="p">):</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">fcn</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">fcn</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">ret</span>

                <span class="n">originalParamNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
                <span class="n">fillNames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">argTypeResult</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">fillNames</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">originalParamNames</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;fill argument names (</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">) are not a subset of function </span><span class="se">\&quot;</span><span class="s">{1}</span><span class="se">\&quot;</span><span class="s"> parameter names (</span><span class="se">\&quot;</span><span class="s">{2}</span><span class="se">\&quot;</span><span class="s">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fillNames</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">originalParamNames</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

                <span class="n">fcnType</span> <span class="o">=</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">P</span><span class="o">.</span><span class="n">mustBeAvro</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">toType</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fillNames</span><span class="p">],</span> <span class="n">P</span><span class="o">.</span><span class="n">mustBeAvro</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">toType</span><span class="p">(</span><span class="n">ret</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IncompatibleTypes</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">IncompatibleTypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;only one-signature functions without constraints can be referenced (wrap </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> in a function definition with the desired signature)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">fcnType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">fcn</span><span class="p">,</span> <span class="n">originalParamNames</span><span class="p">,</span> <span class="n">argTypeResult</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FcnRefFill.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRefFill.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;fcn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;fill&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="FcnRefFill.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.FcnRefFill.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">FcnContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcnType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">fcn</span><span class="p">,</span> <span class="n">originalParamNames</span><span class="p">,</span> <span class="n">argTypeResult</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CallUserFcn"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CallUserFcn">[docs]</a><span class="k">class</span> <span class="nc">CallUserFcn</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">args</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="CallUserFcn.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CallUserFcn.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CallUserFcn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CallUserFcn.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CallUserFcn.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CallUserFcn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                               <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CallUserFcn.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CallUserFcn.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">nameScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">nameContext</span><span class="p">,</span> <span class="n">nameResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">nameScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nameContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroEnum</span><span class="p">):</span>
            <span class="n">fcnNames</span> <span class="o">=</span> <span class="n">nameContext</span><span class="o">.</span><span class="n">retType</span><span class="o">.</span><span class="n">symbols</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">call</span><span class="se">\&quot;</span><span class="s"> name should be an enum, but is &quot;</span> <span class="o">+</span> <span class="n">ts</span><span class="p">(</span><span class="n">nameContext</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">nameToNum</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fcnNames</span><span class="p">))</span>

        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">argResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>

        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s">&quot;u.&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fcnNames</span><span class="p">)</span>
        <span class="n">argTypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">argResults</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ExpressionContext</span><span class="p">):</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>
                <span class="n">argTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">retType</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="n">nameToFcn</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nameToParamTypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nameToRetTypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">retTypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">fcnNames</span><span class="p">:</span>
            <span class="n">fcn</span> <span class="o">=</span> <span class="n">functionTable</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;u.&quot;</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fcn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;unknown function </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> in enumeration type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fcn</span><span class="p">,</span> <span class="n">UserFcn</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;function </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a user function&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">sigres</span> <span class="o">=</span> <span class="n">fcn</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">argTypes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sigres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">paramTypes</span><span class="p">,</span> <span class="n">retType</span> <span class="o">=</span> <span class="n">sigres</span>
                <span class="n">nameToFcn</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcn</span>
                <span class="n">nameToParamTypes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">paramTypes</span>
                <span class="n">nameToRetTypes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">retType</span>
                <span class="n">retTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">retType</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;parameters of function </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> (in enumeration type) do not accept [{1}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">argTypes</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">retType</span> <span class="o">=</span> <span class="n">LabelData</span><span class="o">.</span><span class="n">broadestType</span><span class="p">(</span><span class="n">retTypes</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">IncompatibleTypes</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">nameResult</span><span class="p">,</span> <span class="n">nameToNum</span><span class="p">,</span> <span class="n">nameToFcn</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">argResults</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">argResults</span><span class="p">],</span> <span class="n">nameToParamTypes</span><span class="p">,</span> <span class="n">nameToRetTypes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CallUserFcn.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CallUserFcn.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;call&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CallUserFcn.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CallUserFcn.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">nameToNum</span><span class="p">,</span> <span class="n">nameToFcn</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">argContext</span><span class="p">,</span> <span class="n">nameToParamTypes</span><span class="p">,</span> <span class="n">nameToRetTypes</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Call"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Call">[docs]</a><span class="k">class</span> <span class="nc">Call</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Argument</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">args</span><span class="se">\&quot;</span><span class="s"> must be a list of Arguments&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Call.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Call.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Call</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Call.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Call.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Call.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Call.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">fcn</span> <span class="o">=</span> <span class="n">functionTable</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fcn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;unknown function </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> (be sure to include </span><span class="se">\&quot;</span><span class="s">u.</span><span class="se">\&quot;</span><span class="s"> to reference user functions)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">argResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>

        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="n">argTypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">argResults</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ExpressionContext</span><span class="p">):</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>
                <span class="n">argTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">retType</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">FcnDef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>
                <span class="n">argTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">FcnRef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>
                <span class="n">argTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">FcnRefFill</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>
                <span class="n">argTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)</span>

        <span class="n">sigres</span> <span class="o">=</span> <span class="n">fcn</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">argTypes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sigres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">paramTypes</span><span class="p">,</span> <span class="n">retType</span> <span class="o">=</span> <span class="n">sigres</span>

            <span class="n">argContexts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">argResults</span><span class="p">]</span>
            <span class="n">argTaskResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">argResults</span><span class="p">]</span>

            <span class="c"># Two-parameter task?</span>
            <span class="c"># for i, a in enumerate(self.args):</span>
            <span class="c">#     if isinstance(a, FcnRef):</span>
            <span class="c">#         argTaskResults[i] = task(argContexts[i], engineOptions, paramTypes[i])</span>

            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">fcn</span><span class="p">,</span> <span class="n">argTaskResults</span><span class="p">,</span> <span class="n">argContexts</span><span class="p">,</span> <span class="n">paramTypes</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;parameters of function </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> do not accept [{1}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">argTypes</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Call.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Call.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Call.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Call.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">fcn</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">argContexts</span><span class="p">,</span> <span class="n">paramTypes</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Ref"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ref">[docs]</a><span class="k">class</span> <span class="nc">Ref</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Ref.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ref.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;unknown symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">symbolTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">set</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Ref.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ref.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Ref.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Ref.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralNull"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralNull">[docs]</a><span class="k">class</span> <span class="nc">LiteralNull</span><span class="p">(</span><span class="n">LiteralValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<div class="viewcode-block" id="LiteralNull.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralNull.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LiteralNull.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralNull.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralNull.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralNull.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralBoolean"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralBoolean">[docs]</a><span class="k">class</span> <span class="nc">LiteralBoolean</span><span class="p">(</span><span class="n">LiteralValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s"> must be boolean&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="LiteralBoolean.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralBoolean.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroBoolean</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LiteralBoolean.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralBoolean.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;(boolean)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralBoolean.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralBoolean.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralInt"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralInt">[docs]</a><span class="k">class</span> <span class="nc">LiteralInt</span><span class="p">(</span><span class="n">LiteralValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s"> must be an int&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="LiteralInt.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralInt.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroInt</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LiteralInt.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralInt.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;(int)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralInt.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralInt.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralLong"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralLong">[docs]</a><span class="k">class</span> <span class="nc">LiteralLong</span><span class="p">(</span><span class="n">LiteralValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s"> must be an int&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="LiteralLong.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralLong.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroLong</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LiteralLong.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralLong.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;(long)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralLong.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralLong.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralFloat"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralFloat">[docs]</a><span class="k">class</span> <span class="nc">LiteralFloat</span><span class="p">(</span><span class="n">LiteralValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s"> must be a number&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="LiteralFloat.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralFloat.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroFloat</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LiteralFloat.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralFloat.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;float&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;(float)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralFloat.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralFloat.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralDouble"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralDouble">[docs]</a><span class="k">class</span> <span class="nc">LiteralDouble</span><span class="p">(</span><span class="n">LiteralValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s"> must be a number&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="LiteralDouble.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralDouble.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroDouble</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LiteralDouble.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralDouble.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;(double)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralDouble.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralDouble.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralString"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralString">[docs]</a><span class="k">class</span> <span class="nc">LiteralString</span><span class="p">(</span><span class="n">LiteralValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="LiteralString.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralString.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroString</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LiteralString.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralString.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;(string)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralString.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralString.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralBase64"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralBase64">[docs]</a><span class="k">class</span> <span class="nc">LiteralBase64</span><span class="p">(</span><span class="n">LiteralValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="LiteralBase64.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralBase64.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroBytes</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LiteralBase64.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralBase64.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;base64&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;(bytes)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="LiteralBase64.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.LiteralBase64.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Literal"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Literal">[docs]</a><span class="k">class</span> <span class="nc">Literal</span><span class="p">(</span><span class="n">LiteralValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avroPlaceholder</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">avroPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Literal.equals"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Literal.equals">[docs]</a>    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">avroPlaceholder</span> <span class="ow">and</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Literal.avroType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Literal.avroType">[docs]</a>    <span class="k">def</span> <span class="nf">avroType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
<div class="viewcode-block" id="Literal.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Literal.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Literal.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Literal.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;(literal)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Literal.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Literal.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="NewObject"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewObject">[docs]</a><span class="k">class</span> <span class="nc">NewObject</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">avroPlaceholder</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">fields</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">avroPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="NewObject.equals"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewObject.equals">[docs]</a>    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NewObject</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">fields</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">avroPlaceholder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="NewObject.avroType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewObject.avroType">[docs]</a>    <span class="k">def</span> <span class="nf">avroType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
<div class="viewcode-block" id="NewObject.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewObject.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NewObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="NewObject.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewObject.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NewObject</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NewObject.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewObject.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">fieldNameTypeExpr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>
            <span class="n">fieldNameTypeExpr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">exprResult</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">AvroRecord</span><span class="p">):</span>
            <span class="n">fldsMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">avroType</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="o">.</span><span class="n">fieldsDict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="n">fieldNameTypeExpr</span><span class="p">:</span>
                <span class="n">fieldType</span> <span class="o">=</span> <span class="n">fldsMap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fieldType</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;record constructed with </span><span class="se">\&quot;</span><span class="s">new</span><span class="se">\&quot;</span><span class="s"> has unexpected field named </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldType</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;record constructed with </span><span class="se">\&quot;</span><span class="s">new</span><span class="se">\&quot;</span><span class="s"> is has wrong field type for </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">: {1} rather than {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">fieldType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">fldsMap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="n">fieldNameTypeExpr</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;record constructed with </span><span class="se">\&quot;</span><span class="s">new</span><span class="se">\&quot;</span><span class="s"> is missing fields: {0} rather than {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="n">fieldNameTypeExpr</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fldsMap</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">AvroMap</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="n">fieldNameTypeExpr</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;map constructed with </span><span class="se">\&quot;</span><span class="s">new</span><span class="se">\&quot;</span><span class="s"> has wrong type for value associated with key </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">: {1} rather than {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;object constructed with </span><span class="se">\&quot;</span><span class="s">new</span><span class="se">\&quot;</span><span class="s"> must have record or map type, not {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fieldNameTypeExpr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NewObject.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewObject.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;new (object)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="NewObject.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewObject.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="NewArray"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewArray">[docs]</a><span class="k">class</span> <span class="nc">NewArray</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">avroPlaceholder</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">items</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">avroPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="NewArray.equals"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewArray.equals">[docs]</a>    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NewArray</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">avroPlaceholder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="NewArray.avroType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewArray.avroType">[docs]</a>    <span class="k">def</span> <span class="nf">avroType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
<div class="viewcode-block" id="NewArray.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewArray.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NewArray</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NewArray.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewArray.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NewArray</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NewArray.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewArray.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">itemTypeExpr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>
            <span class="n">itemTypeExpr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">exprResult</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">AvroArray</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemTypeExpr</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;array constructed with </span><span class="se">\&quot;</span><span class="s">new</span><span class="se">\&quot;</span><span class="s"> has wrong type for item {0}: {1} rather than {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="o">.</span><span class="n">items</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;array constructed with </span><span class="se">\&quot;</span><span class="s">new</span><span class="se">\&quot;</span><span class="s"> must have array type, not {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itemTypeExpr</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NewArray.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewArray.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;new (array)&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="NewArray.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.NewArray.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Do"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Do">[docs]</a><span class="k">class</span> <span class="nc">Do</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">body</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">do</span><span class="se">\&quot;</span><span class="s"> block must contain at least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Do.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Do.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Do</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Do.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Do.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Do</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Do.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Do.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>

        <span class="n">inferredType</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inferredType</span><span class="p">,</span> <span class="n">ExceptionType</span><span class="p">):</span>
            <span class="n">inferredType</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">()</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">inferredType</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calls</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]))</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">scope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Do.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Do.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;do&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;do&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Do.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Do.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">exprs</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Let"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Let">[docs]</a><span class="k">class</span> <span class="nc">Let</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">values</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">let</span><span class="se">\&quot;</span><span class="s"> must contain at least one declaration&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Let.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Let.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Let</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Let.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Let.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Let</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Let.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Let.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">sealedWithin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;new variable bindings are forbidden in this scope, but you can wrap your expression with </span><span class="se">\&quot;</span><span class="s">do</span><span class="se">\&quot;</span><span class="s"> to make temporary variables&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">newSymbols</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">nameTypeExpr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> may not be redeclared or shadowed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">validSymbolName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid symbol name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">ExceptionType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;cannot declare a variable with exception type&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">newSymbols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span>

            <span class="n">nameTypeExpr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">exprResult</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">avroType</span> <span class="ow">in</span> <span class="n">newSymbols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">symbolTable</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">avroType</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">nameTypeExpr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Let.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Let.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;let&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;let&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Let.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Let.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">nameTypeExpr</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="SetVar"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SetVar">[docs]</a><span class="k">class</span> <span class="nc">SetVar</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">values</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">set</span><span class="se">\&quot;</span><span class="s"> must contain at least one assignment&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="SetVar.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SetVar.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SetVar</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="SetVar.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SetVar.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SetVar</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SetVar.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SetVar.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">nameTypeExpr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;unknown symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> cannot be assigned with </span><span class="se">\&quot;</span><span class="s">set</span><span class="se">\&quot;</span><span class="s"> (use </span><span class="se">\&quot;</span><span class="s">let</span><span class="se">\&quot;</span><span class="s"> to declare a new symbol)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">writable</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> belongs to a sealed enclosing scope; it cannot be modified within this block)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">symbolTable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> was declared as {1}; it cannot be re-assigned as {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">symbolTable</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span> <span class="n">ts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">nameTypeExpr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">exprResult</span><span class="p">))</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">nameTypeExpr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SetVar.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SetVar.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;set&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="SetVar.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.SetVar.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">nameTypeExpr</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="AttrGet"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrGet">[docs]</a><span class="k">class</span> <span class="nc">AttrGet</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="n">HasPath</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">expr</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">path</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;attr path must have at least one key&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="AttrGet.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrGet.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AttrGet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttrGet.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrGet.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AttrGet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                           <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttrGet.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrGet.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">exprScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">exprScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroArray</span><span class="p">,</span> <span class="n">AvroMap</span><span class="p">,</span> <span class="n">AvroRecord</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;expression is not an array, map, or record&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">pathResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walkPath</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">exprResult</span><span class="p">,</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttrGet.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrGet.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;attr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;attr&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="AttrGet.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrGet.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">exprType</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="AttrTo"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrTo">[docs]</a><span class="k">class</span> <span class="nc">AttrTo</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="n">HasPath</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">expr</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">path</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">Argument</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">to</span><span class="se">\&quot;</span><span class="s"> must be an Argument&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;attr path must have at least one key&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="AttrTo.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrTo.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AttrTo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttrTo.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrTo.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AttrTo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                          <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttrTo.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrTo.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">exprScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">exprScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroArray</span><span class="p">,</span> <span class="n">AvroMap</span><span class="p">,</span> <span class="n">AvroRecord</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;expression is not an array, map, or record&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">setType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">pathResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walkPath</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="n">toContext</span><span class="p">,</span> <span class="n">toResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">ExpressionContext</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">setType</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;attr-and-path has type {0} but attempting to assign with type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">exprResult</span><span class="p">,</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">toResult</span><span class="p">,</span> <span class="n">toContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">FcnDef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">setType</span><span class="p">],</span> <span class="n">setType</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;attr-and-path has type {0} but attempting to assign with a function of type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">exprResult</span><span class="p">,</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">toResult</span><span class="p">,</span> <span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">FcnRef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">setType</span><span class="p">],</span> <span class="n">setType</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;attr-and-path has type {0} but attempting to assign with a function of type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">exprResult</span><span class="p">,</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">),</span> <span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)</span>   <span class="c"># Two-parameter task?  task(toContext, engineOptions, toContext.fcnType)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">FcnRefFill</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">setType</span><span class="p">],</span> <span class="n">setType</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;attr-and-path has type {0} but attempting to assign with a function of type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">exprResult</span><span class="p">,</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">),</span> <span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)</span>   <span class="c"># Two-parameter task?  task(toContext, engineOptions, toContext.fcnType)</span>

        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="AttrTo.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrTo.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;attr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;attr-to&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="AttrTo.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.AttrTo.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">exprType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">toType</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CellGet"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellGet">[docs]</a><span class="k">class</span> <span class="nc">CellGet</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="n">HasPath</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">cell</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">path</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="CellGet.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellGet.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CellGet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CellGet.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellGet.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CellGet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CellGet.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellGet.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;no cell named </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">cellType</span><span class="p">,</span> <span class="n">shared</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">shared</span>

        <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">pathResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walkPath</span><span class="p">(</span><span class="n">cellType</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">cellType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CellGet.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellGet.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;cell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;cell&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CellGet.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellGet.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">cellType</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CellTo"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellTo">[docs]</a><span class="k">class</span> <span class="nc">CellTo</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="n">HasPath</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">cell</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">path</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">Argument</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">to</span><span class="se">\&quot;</span><span class="s"> must be an Argument&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="CellTo.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellTo.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CellTo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CellTo.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellTo.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CellTo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CellTo.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellTo.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;no cell named </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">cellType</span><span class="p">,</span> <span class="n">shared</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">shared</span>

        <span class="n">setType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">pathResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walkPath</span><span class="p">(</span><span class="n">cellType</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="n">toContext</span><span class="p">,</span> <span class="n">toResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">ExpressionContext</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">setType</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;cell-and-path has type {0} but attempting to assign with type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">cellType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">cellType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">toResult</span><span class="p">,</span> <span class="n">toContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">FcnDef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">setType</span><span class="p">],</span> <span class="n">setType</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;cell-and-path has type {0} but attempting to assign with a function of type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">cellType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">cellType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">toResult</span><span class="p">,</span> <span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">FcnRef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">setType</span><span class="p">],</span> <span class="n">setType</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;cell-and-path has type {0} but attempting to assign with a function of type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">cellType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">cellType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">),</span> <span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>  <span class="c"># Two-parameter task?  task(toContext, engineOptions, toContext.fcnType)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">FcnRefFill</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">setType</span><span class="p">],</span> <span class="n">setType</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;cell-and-path has type {0} but attempting to assign with a function of type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">cellType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">cellType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">),</span> <span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>  <span class="c"># Two-parameter task?  task(toContext, engineOptions, toContext.fcnType)</span>

        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CellTo.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellTo.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;cell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;cell-to&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CellTo.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CellTo.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">cellType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">toType</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="PoolGet"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolGet">[docs]</a><span class="k">class</span> <span class="nc">PoolGet</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="n">HasPath</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pool</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">path</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;pool path must have at least one key&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="PoolGet.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolGet.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PoolGet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PoolGet.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolGet.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PoolGet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PoolGet.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolGet.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;no pool named </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">poolType</span><span class="p">,</span> <span class="n">shared</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">shared</span>

        <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">pathResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walkPath</span><span class="p">(</span><span class="n">AvroMap</span><span class="p">(</span><span class="n">poolType</span><span class="p">),</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="PoolGet.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolGet.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;pool&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="PoolGet.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolGet.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="PoolTo"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolTo">[docs]</a><span class="k">class</span> <span class="nc">PoolTo</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="n">HasPath</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pool</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">path</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">Argument</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">to</span><span class="se">\&quot;</span><span class="s"> must be an Argument&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">init</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;pool path must have at least one key&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="PoolTo.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolTo.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PoolTo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PoolTo.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolTo.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PoolTo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PoolTo.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolTo.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;no pool named </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">poolType</span><span class="p">,</span> <span class="n">shared</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">shared</span>

        <span class="n">setType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">pathResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walkPath</span><span class="p">(</span><span class="n">AvroMap</span><span class="p">(</span><span class="n">poolType</span><span class="p">),</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="n">toContext</span><span class="p">,</span> <span class="n">toResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="n">initContext</span><span class="p">,</span> <span class="n">initResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">poolType</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">initContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;pool has type {0} but attempting to init with type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">poolType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">initContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">ExpressionContext</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">setType</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;pool-and-path has type {0} but attempting to assign with type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">poolType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">poolType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">toResult</span><span class="p">,</span> <span class="n">toContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">initResult</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">FcnDef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">setType</span><span class="p">],</span> <span class="n">setType</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;pool-and-path has type {0} but attempting to assign with a function of type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">poolType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">poolType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">toResult</span><span class="p">,</span> <span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">,</span> <span class="n">initResult</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">FcnRef</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">setType</span><span class="p">],</span> <span class="n">setType</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;pool-and-path has type {0} but attempting to assign with a function of type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">poolType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">poolType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">),</span> <span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">,</span> <span class="n">initResult</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>  <span class="c"># Two-parameter task?  task(toContext, engineOptions, toContext.fcnType)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">FcnRefFill</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FcnType</span><span class="p">([</span><span class="n">setType</span><span class="p">],</span> <span class="n">setType</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;pool-and-path has type {0} but attempting to assign with a function of type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">setType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">poolType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">toContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">poolType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">pathResult</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">toContext</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">),</span> <span class="n">toContext</span><span class="o">.</span><span class="n">fcnType</span><span class="p">,</span> <span class="n">initResult</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>  <span class="c"># Two-parameter task?  task(toContext, engineOptions, toContext.fcnType)</span>

        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PoolTo.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolTo.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;pool-to&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="PoolTo.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.PoolTo.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">poolType</span><span class="p">,</span> <span class="n">setType</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">toType</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="If"><a class="viewcode-back" href="../../titus.html#titus.pfaast.If">[docs]</a><span class="k">class</span> <span class="nc">If</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">predicate</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thenClause</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thenClause</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">thenClause</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elseClause</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elseClause</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">elseClause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">elseClause</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">then</span><span class="se">\&quot;</span><span class="s"> clause must contain at least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">else</span><span class="se">\&quot;</span><span class="s"> clause must contain at least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="If.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.If.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">If</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">+</span> \
               <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[])</span>
</div>
<div class="viewcode-block" id="If.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.If.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">If</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                      <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">],</span>
                      <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="If.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.If.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">predScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">predContext</span><span class="p">,</span> <span class="n">predResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">predScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AvroBoolean</span><span class="p">()</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">if</span><span class="se">\&quot;</span><span class="s"> predicate should be boolean, but is &quot;</span> <span class="o">+</span> <span class="n">ts</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">thenScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">thenResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">thenResults</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">elseScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

            <span class="n">elseResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">elseScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">elseResults</span><span class="p">:</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="n">thenType</span> <span class="o">=</span> <span class="n">thenResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span>
            <span class="n">elseType</span> <span class="o">=</span> <span class="n">elseResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thenType</span><span class="p">,</span> <span class="n">ExceptionType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elseType</span><span class="p">,</span> <span class="n">ExceptionType</span><span class="p">):</span>
                <span class="n">retType</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">retType</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">mustBeAvro</span><span class="p">(</span><span class="n">LabelData</span><span class="o">.</span><span class="n">broadestType</span><span class="p">([</span><span class="n">thenType</span><span class="p">,</span> <span class="n">elseType</span><span class="p">]))</span>
                <span class="k">except</span> <span class="n">IncompatibleTypes</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">retType</span><span class="p">,</span> <span class="n">elseTaskResults</span><span class="p">,</span> <span class="n">elseSymbols</span> <span class="o">=</span> <span class="n">retType</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elseResults</span><span class="p">],</span> <span class="n">elseScope</span><span class="o">.</span><span class="n">inThisScope</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retType</span><span class="p">,</span> <span class="n">elseTaskResults</span><span class="p">,</span> <span class="n">elseSymbols</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">(),</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">thenScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="n">predResult</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thenResults</span><span class="p">],</span> <span class="n">elseSymbols</span><span class="p">,</span> <span class="n">elseTaskResults</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="If.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.If.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;if&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;then&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;else&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;if&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="If.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.If.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">thenSymbols</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">,</span> <span class="n">elseSymbols</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Cond"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cond">[docs]</a><span class="k">class</span> <span class="nc">Cond</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifthens</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ifthens</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">If</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ifthens</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">ifthens</span><span class="se">\&quot;</span><span class="s"> must be a list of Ifs&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elseClause</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elseClause</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">elseClause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">elseClause</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifthens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">cond</span><span class="se">\&quot;</span><span class="s"> must contain at least one predicate-block pair&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">ifthens</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">then</span><span class="se">\&quot;</span><span class="s"> clause must contain at least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">else</span><span class="se">\&quot;</span><span class="s"> clause must contain at least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Cond.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cond.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Cond</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifthens</span><span class="p">)</span> <span class="o">+</span> \
               <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[])</span>
</div>
<div class="viewcode-block" id="Cond.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cond.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Cond</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifthens</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cond.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cond.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">walkBlocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ifthen</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifthens</span><span class="p">:</span>
            <span class="n">predicate</span> <span class="o">=</span> <span class="n">ifthen</span><span class="o">.</span><span class="n">predicate</span>
            <span class="n">thenClause</span> <span class="o">=</span> <span class="n">ifthen</span><span class="o">.</span><span class="n">thenClause</span>
            <span class="n">ifpos</span> <span class="o">=</span> <span class="n">ifthen</span><span class="o">.</span><span class="n">pos</span>

            <span class="n">predScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">predContext</span><span class="p">,</span> <span class="n">predResult</span> <span class="o">=</span> <span class="n">predicate</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">predScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">AvroBoolean</span><span class="p">()</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">if</span><span class="se">\&quot;</span><span class="s"> predicate should be boolean, but is &quot;</span> <span class="o">+</span> <span class="n">ts</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="n">ifpos</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="n">thenScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">thenResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thenClause</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">thenResults</span><span class="p">:</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="n">walkBlocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WalkBlock</span><span class="p">(</span><span class="n">thenResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">thenScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="n">predResult</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thenResults</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">elseScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

            <span class="n">elseResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">elseScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">elseResults</span><span class="p">:</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="n">walkBlocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cond</span><span class="o">.</span><span class="n">WalkBlock</span><span class="p">(</span><span class="n">elseResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">elseScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elseResults</span><span class="p">]))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">retType</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">walkTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">retType</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">walkBlocks</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ExceptionType</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">walkTypes</span><span class="p">):</span>
                <span class="n">retType</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">retType</span> <span class="o">=</span> <span class="n">LabelData</span><span class="o">.</span><span class="n">broadestType</span><span class="p">(</span><span class="n">walkTypes</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">IncompatibleTypes</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">),</span> <span class="n">walkBlocks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cond.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cond.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;cond&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifthens</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;else&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;cond&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Cond.WalkBlock"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cond.WalkBlock">[docs]</a>    <span class="k">class</span> <span class="nc">WalkBlock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">exprs</span><span class="p">):</span> <span class="k">pass</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Cond.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Cond.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="n">walkBlocks</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="While"><a class="viewcode-back" href="../../titus.html#titus.pfaast.While">[docs]</a><span class="k">class</span> <span class="nc">While</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">predicate</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">body</span><span class="se">\&quot;</span><span class="s"> must be XXX&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="While.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.While.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">While</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="While.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.While.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">While</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                         <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="While.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.While.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">loopScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">predScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="n">predContext</span><span class="p">,</span> <span class="n">predResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">predScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AvroBoolean</span><span class="p">()</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">while</span><span class="se">\&quot;</span><span class="s"> predicate should be boolean, but is &quot;</span> <span class="o">+</span> <span class="n">ts</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">loopResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">loopScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">loopResults</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="n">predResult</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loopResults</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="While.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.While.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;while&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;do&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;while&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="While.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.While.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="DoUntil"><a class="viewcode-back" href="../../titus.html#titus.pfaast.DoUntil">[docs]</a><span class="k">class</span> <span class="nc">DoUntil</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">body</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">predicate</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="DoUntil.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.DoUntil.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DoUntil</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DoUntil.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.DoUntil.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DoUntil</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DoUntil.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.DoUntil.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">loopScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">predScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="n">loopResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">loopScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">loopResults</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">predContext</span><span class="p">,</span> <span class="n">predResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">predScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AvroBoolean</span><span class="p">()</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">until</span><span class="se">\&quot;</span><span class="s"> predicate should be boolean, but is &quot;</span> <span class="o">+</span> <span class="n">ts</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">predContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loopResults</span><span class="p">],</span> <span class="n">predResult</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DoUntil.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.DoUntil.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;do&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;until&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;do-until&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="DoUntil.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.DoUntil.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="For"><a class="viewcode-back" href="../../titus.html#titus.pfaast.For">[docs]</a><span class="k">class</span> <span class="nc">For</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">init</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">init</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">predicate</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">step</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">body</span><span class="se">\&quot;</span><span class="s"> must be XXX&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">for</span><span class="se">\&quot;</span><span class="s"> must contain at least one declaration&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">step</span><span class="se">\&quot;</span><span class="s"> must contain at least one assignment&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">do</span><span class="se">\&quot;</span><span class="s"> must contain at least one statement&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="For.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.For.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">For</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="For.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.For.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">For</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                       <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                       <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">],</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="For.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.For.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">loopScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">newSymbols</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">initNameTypeExpr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> may not be redeclared or shadowed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">validSymbolName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid symbol name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">initScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">initScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="n">newSymbols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span>
            
            <span class="n">initNameTypeExpr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">exprResult</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">avroType</span> <span class="ow">in</span> <span class="n">newSymbols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">loopScope</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">avroType</span><span class="p">)</span>

        <span class="n">predicateScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">predicateContext</span><span class="p">,</span> <span class="n">predicateResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">predicateScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AvroBoolean</span><span class="p">()</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">predicateContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;predicate should be boolean, but is &quot;</span> <span class="o">+</span> <span class="n">ts</span><span class="p">(</span><span class="n">predicateContext</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">predicateContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">stepNameTypeExpr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;unknown symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> cannot be assigned with </span><span class="se">\&quot;</span><span class="s">step</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">writable</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> belongs to a sealed enclosing scope; it cannot be modified within this block&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">stepScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">stepScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">loopScope</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> was declared as {1}; it cannot be re-assigned as {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">loopScope</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span> <span class="n">ts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">stepNameTypeExpr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">loopScope</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">exprResult</span><span class="p">))</span>

        <span class="n">bodyScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">bodyResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">bodyScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">bodyResults</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bodyScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">loopScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">initNameTypeExpr</span><span class="p">,</span> <span class="n">predicateResult</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bodyResults</span><span class="p">],</span> <span class="n">stepNameTypeExpr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="For.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.For.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;for&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;while&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;do&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;for&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="For.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.For.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">initNameTypeExpr</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">,</span> <span class="n">stepNameTypeExpr</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Foreach"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Foreach">[docs]</a><span class="k">class</span> <span class="nc">Foreach</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">array</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">body</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">seq</span><span class="se">\&quot;</span><span class="s"> must be boolean&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">do</span><span class="se">\&quot;</span><span class="s"> must contain at least one statement&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Foreach.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Foreach.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Foreach</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Foreach.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Foreach.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Foreach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                           <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Foreach.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Foreach.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">loopScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> may not be redeclared or shadowed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">validSymbolName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid symbol name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">objScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">objContext</span><span class="p">,</span> <span class="n">objResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">objScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">objContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroArray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;expression referred to by </span><span class="se">\&quot;</span><span class="s">in</span><span class="se">\&quot;</span><span class="s"> should be an array, but is &quot;</span> <span class="o">+</span> <span class="n">ts</span><span class="p">(</span><span class="n">objContext</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">elementType</span> <span class="o">=</span> <span class="n">objContext</span><span class="o">.</span><span class="n">retType</span><span class="o">.</span><span class="n">items</span>

        <span class="n">loopScope</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">elementType</span><span class="p">)</span>

        <span class="n">bodyScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">bodyResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">bodyScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">bodyResults</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bodyScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">loopScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">objContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">objResult</span><span class="p">,</span> <span class="n">elementType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bodyResults</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Foreach.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Foreach.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;foreach&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;do&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;seq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;foreach&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Foreach.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Foreach.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">objType</span><span class="p">,</span> <span class="n">objExpr</span><span class="p">,</span> <span class="n">itemType</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Forkeyval"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Forkeyval">[docs]</a><span class="k">class</span> <span class="nc">Forkeyval</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forkey</span><span class="p">,</span> <span class="n">forval</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">forkey</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">forkey</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">forval</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">forval</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">map</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">body</span><span class="se">\&quot;</span><span class="s"> must be a list of Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">do</span><span class="se">\&quot;</span><span class="s"> must contain at least one statement&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Forkeyval.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Forkeyval.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Forkeyval</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Forkeyval.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Forkeyval.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Forkeyval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forkey</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">forval</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                             <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Forkeyval.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Forkeyval.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">loopScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forkey</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> may not be redeclared or shadowed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forkey</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forval</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> may not be redeclared or shadowed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forval</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">validSymbolName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forkey</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid symbol name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forkey</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validSymbolName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forval</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid symbol name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forval</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">objScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">objContext</span><span class="p">,</span> <span class="n">objResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">objScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">objContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroMap</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;expression referred to by </span><span class="se">\&quot;</span><span class="s">in</span><span class="se">\&quot;</span><span class="s"> should be a map, but is &quot;</span> <span class="o">+</span> <span class="n">ts</span><span class="p">(</span><span class="n">objContext</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">elementType</span> <span class="o">=</span> <span class="n">objContext</span><span class="o">.</span><span class="n">retType</span><span class="o">.</span><span class="n">values</span>

        <span class="n">loopScope</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forkey</span><span class="p">,</span> <span class="n">AvroString</span><span class="p">())</span>
        <span class="n">loopScope</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forval</span><span class="p">,</span> <span class="n">elementType</span><span class="p">)</span>

        <span class="n">bodyScope</span> <span class="o">=</span> <span class="n">loopScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">bodyResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">bodyScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">bodyResults</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bodyScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">loopScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">objContext</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">objResult</span><span class="p">,</span> <span class="n">elementType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">forkey</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">forval</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bodyResults</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Forkeyval.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Forkeyval.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;forkey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forkey</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;forval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forval</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;do&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;forkey-forval&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Forkeyval.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Forkeyval.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">objType</span><span class="p">,</span> <span class="n">objExpr</span><span class="p">,</span> <span class="n">valueType</span><span class="p">,</span> <span class="n">forkey</span><span class="p">,</span> <span class="n">forval</span><span class="p">,</span> <span class="n">loopBody</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CastCase"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastCase">[docs]</a><span class="k">class</span> <span class="nc">CastCase</span><span class="p">(</span><span class="n">Ast</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avroPlaceholder</span><span class="p">,</span> <span class="n">named</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">avroPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">named</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">named</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">body</span><span class="se">\&quot;</span><span class="s"> must be a list of Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">do</span><span class="se">\&quot;</span><span class="s"> must contain at least one statement&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">validSymbolName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">named</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid symbol name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">named</span><span class="p">),</span> <span class="n">pos</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="CastCase.avroType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastCase.avroType">[docs]</a>    <span class="k">def</span> <span class="nf">avroType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
<div class="viewcode-block" id="CastCase.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastCase.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CastCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CastCase.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastCase.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CastCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">named</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CastCase.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastCase.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">scope</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">named</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">named</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calls</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])),</span> <span class="n">scope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CastCase.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastCase.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;as&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;named&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">named</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;do&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CastCase.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastCase.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">AstContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">toType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">clause</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CastBlock"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastBlock">[docs]</a><span class="k">class</span> <span class="nc">CastBlock</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">castCases</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">expr</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">castCases</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">CastCase</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">castCases</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">castCases</span><span class="se">\&quot;</span><span class="s"> must be a list of CastCases&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partial</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">partial</span><span class="se">\&quot;</span><span class="s"> must be boolean&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="CastBlock.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastBlock.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CastBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">castCases</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CastBlock.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastBlock.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CastBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                             <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">castCases</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CastBlock.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastBlock.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">exprScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">exprScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">exprType</span> <span class="o">=</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">avroType</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">castCases</span><span class="p">]</span>

        <span class="c"># did you have anything extraneous?</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exprType</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">cast</span><span class="se">\&quot;</span><span class="s"> of expression with type {0} can never satisfy case {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">exprType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">t</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">castCases</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">castCtx</span><span class="p">,</span> <span class="n">castRes</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">castCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="p">:</span>
            <span class="n">retType</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># are you missing anything necessary?</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprType</span><span class="p">,</span> <span class="n">AvroUnion</span><span class="p">):</span>
                <span class="n">mustFindThese</span> <span class="o">=</span> <span class="n">exprType</span><span class="o">.</span><span class="n">types</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mustFindThese</span> <span class="o">=</span> <span class="p">[</span><span class="n">exprType</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">mustFind</span> <span class="ow">in</span> <span class="n">mustFindThese</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">mustFind</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mustFind</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">cast</span><span class="se">\&quot;</span><span class="s"> of expression with type {0} does not contain a case for {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">exprType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="n">mustFind</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">retType</span> <span class="o">=</span> <span class="n">LabelData</span><span class="o">.</span><span class="n">broadestType</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">IncompatibleTypes</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">exprType</span><span class="p">,</span> <span class="n">exprResult</span><span class="p">,</span> <span class="n">cases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CastBlock.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastBlock.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;cast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;cases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">castCases</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;partial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;cast-cases&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="CastBlock.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.CastBlock.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">exprType</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">cases</span><span class="p">,</span> <span class="n">partial</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Upcast"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Upcast">[docs]</a><span class="k">class</span> <span class="nc">Upcast</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">avroPlaceholder</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">expr</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avroPlaceholder</span><span class="p">,</span> <span class="p">(</span><span class="n">AvroPlaceholder</span><span class="p">,</span> <span class="n">AvroType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">avroPlaceholder</span><span class="se">\&quot;</span><span class="s"> must be an AvroPlaceholder or AvroType&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Upcast.avroType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Upcast.avroType">[docs]</a>    <span class="k">def</span> <span class="nf">avroType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">avroType</span>
</div>
<div class="viewcode-block" id="Upcast.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Upcast.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Upcast</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Upcast.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Upcast.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Upcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Upcast.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Upcast.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">exprContext</span><span class="p">,</span> <span class="n">exprResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;expression results in {0}; cannot expand (</span><span class="se">\&quot;</span><span class="s">upcast</span><span class="se">\&quot;</span><span class="s">) to {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">exprContext</span><span class="o">.</span><span class="n">retType</span><span class="p">),</span> <span class="n">ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avroType</span><span class="p">,</span> <span class="n">exprContext</span><span class="o">.</span><span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">exprResult</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Upcast.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Upcast.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;upcast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;as&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avroPlaceholder</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;upcast&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Upcast.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Upcast.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="IfNotNull"><a class="viewcode-back" href="../../titus.html#titus.pfaast.IfNotNull">[docs]</a><span class="k">class</span> <span class="nc">IfNotNull</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exprs</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exprs</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">exprs</span><span class="se">\&quot;</span><span class="s"> must be a dictionary of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thenClause</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thenClause</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">thenClause</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elseClause</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elseClause</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">elseClause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">elseClause</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">ifnotnull</span><span class="se">\&quot;</span><span class="s"> must contain at least one symbol-expression mapping&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">then</span><span class="se">\&quot;</span><span class="s"> clause must contain at least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">else</span><span class="se">\&quot;</span><span class="s"> clause must contain at least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="IfNotNull.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.IfNotNull.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">IfNotNull</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">+</span> \
               <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[])</span>
</div>
<div class="viewcode-block" id="IfNotNull.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.IfNotNull.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">IfNotNull</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                             <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">],</span>
                             <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IfNotNull.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.IfNotNull.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">exprArgsScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">assignmentScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">symbolTypeResult</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validSymbolName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid symbol name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">exprArgsScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

            <span class="n">avroType</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroUnion</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">AvroNull</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exprCtx</span><span class="o">.</span><span class="n">retType</span><span class="o">.</span><span class="n">types</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">retType</span><span class="o">.</span><span class="n">types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroUnion</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exprCtx</span><span class="o">.</span><span class="n">retType</span><span class="o">.</span><span class="n">types</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">AvroNull</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">retType</span><span class="o">.</span><span class="n">types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">avroType</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exprCtx</span><span class="o">.</span><span class="n">retType</span><span class="o">.</span><span class="n">types</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">AvroNull</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">avroType</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">ifnotnull</span><span class="se">\&quot;</span><span class="s"> expressions must all be unions of something and null; case </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> has type {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ts</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">retType</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">assignmentScope</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">avroType</span><span class="p">)</span>

            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="n">symbolTypeResult</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">avroType</span><span class="p">,</span> <span class="n">exprRes</span><span class="p">))</span>

        <span class="n">thenScope</span> <span class="o">=</span> <span class="n">assignmentScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">thenResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">thenResults</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">elseScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

            <span class="n">elseResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">elseScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">elseResults</span><span class="p">:</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="n">thenType</span> <span class="o">=</span> <span class="n">thenResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span>
            <span class="n">elseType</span> <span class="o">=</span> <span class="n">elseResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">retType</span> <span class="o">=</span> <span class="n">LabelData</span><span class="o">.</span><span class="n">broadestType</span><span class="p">([</span><span class="n">thenType</span><span class="p">,</span> <span class="n">elseType</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">IncompatibleTypes</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">retType</span><span class="p">,</span> <span class="n">elseTaskResults</span><span class="p">,</span> <span class="n">elseSymbols</span> <span class="o">=</span> <span class="n">retType</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elseResults</span><span class="p">],</span> <span class="n">elseScope</span><span class="o">.</span><span class="n">inThisScope</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retType</span><span class="p">,</span> <span class="n">elseTaskResults</span><span class="p">,</span> <span class="n">elseSymbols</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">(),</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">symbolTypeResult</span><span class="p">,</span> <span class="n">thenScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thenResults</span><span class="p">],</span> <span class="n">elseSymbols</span><span class="p">,</span> <span class="n">elseTaskResults</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IfNotNull.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.IfNotNull.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">jsonExprs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">jsonExprs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;ifnotnull&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonExprs</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;then&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;else&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;ifnotnull&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="IfNotNull.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.IfNotNull.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbolTypeResult</span><span class="p">,</span> <span class="n">thenSymbols</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">,</span> <span class="n">elseSymbols</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<div class="viewcode-block" id="BinaryFormatter"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter">[docs]</a><span class="k">class</span> <span class="nc">BinaryFormatter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">formatPad</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(pad)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatBoolean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(boolean)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatByte</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(byte|int8)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatUnsignedByte</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*unsigned\s*(byte|int8)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatShort</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(&lt;|&gt;|!|little|big|network)?\s*(short|int16)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatUnsignedShort</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(&lt;|&gt;|!|little|big|network)?\s*(unsigned\s*short|unsigned\s*int16)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatInt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(&lt;|&gt;|!|little|big|network)?\s*(int|int32)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatUnsignedInt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(&lt;|&gt;|!|little|big|network)?\s*(unsigned\s*int|unsigned\s*int32)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatLong</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(&lt;|&gt;|!|little|big|network)?\s*(long|long\s+long|int64)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatUnsignedLong</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(&lt;|&gt;|!|little|big|network)?\s*(unsigned\s*long|unsigned\s*long\s+long|unsigned\s*int64)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatFloat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(&lt;|&gt;|!|little|big|network)?\s*(float|float32)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatDouble</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(&lt;|&gt;|!|little|big|network)?\s*(double|float64)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatRaw</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*raw\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatRawSize</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*raw\s*([0-9]+)\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatToNull</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(null\s*)?terminated\s*&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">formatPrefixed</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;&quot;&quot;\s*(length\s*)?prefixed\s*&quot;&quot;&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="BinaryFormatter.Declare"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.Declare">[docs]</a>    <span class="k">class</span> <span class="nc">Declare</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="k">pass</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclarePad"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclarePad">[docs]</a>    <span class="k">class</span> <span class="nc">DeclarePad</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">x</span><span class="se">\&quot;</span><span class="s">, 1)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareBoolean"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareBoolean">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareBoolean</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroBoolean</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">?</span><span class="se">\&quot;</span><span class="s">, 1)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareByte"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareByte">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareByte</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroInt</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsigned</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">B</span><span class="se">\&quot;</span><span class="s">, 1)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">b</span><span class="se">\&quot;</span><span class="s">, 1)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareShort"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareShort">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareShort</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">littleEndian</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroInt</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsigned</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">littleEndian</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&lt;H</span><span class="se">\&quot;</span><span class="s">, 2)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&gt;H</span><span class="se">\&quot;</span><span class="s">, 2)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">littleEndian</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&lt;h</span><span class="se">\&quot;</span><span class="s">, 2)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&gt;h</span><span class="se">\&quot;</span><span class="s">, 2)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareInt"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareInt">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareInt</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">littleEndian</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">):</span> <span class="k">pass</span>
        <span class="nd">@property</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareInt.avroType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareInt.avroType">[docs]</a>        <span class="k">def</span> <span class="nf">avroType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsigned</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AvroLong</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AvroInt</span><span class="p">()</span></div>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsigned</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">littleEndian</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&lt;I</span><span class="se">\&quot;</span><span class="s">, 4)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&gt;I</span><span class="se">\&quot;</span><span class="s">, 4)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">littleEndian</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&lt;i</span><span class="se">\&quot;</span><span class="s">, 4)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&gt;i</span><span class="se">\&quot;</span><span class="s">, 4)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareLong"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareLong">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareLong</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">littleEndian</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">):</span> <span class="k">pass</span>
        <span class="nd">@property</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareLong.avroType"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareLong.avroType">[docs]</a>        <span class="k">def</span> <span class="nf">avroType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsigned</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AvroDouble</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AvroLong</span><span class="p">()</span></div>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsigned</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">littleEndian</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&lt;Q</span><span class="se">\&quot;</span><span class="s">, 8)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&gt;Q</span><span class="se">\&quot;</span><span class="s">, 8)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">littleEndian</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&lt;q</span><span class="se">\&quot;</span><span class="s">, 8)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&gt;q</span><span class="se">\&quot;</span><span class="s">, 8)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareFloat"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareFloat">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareFloat</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">littleEndian</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroFloat</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">littleEndian</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&lt;f</span><span class="se">\&quot;</span><span class="s">, 4)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&gt;f</span><span class="se">\&quot;</span><span class="s">, 4)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareDouble"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareDouble">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareDouble</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">littleEndian</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroDouble</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">littleEndian</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&lt;d</span><span class="se">\&quot;</span><span class="s">, 8)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">&gt;d</span><span class="se">\&quot;</span><span class="s">, 8)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareRaw"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareRaw">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareRaw</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroBytes</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">raw</span><span class="se">\&quot;</span><span class="s">, None)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareRawSize"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareRawSize">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareRawSize</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroBytes</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">raw</span><span class="se">\&quot;</span><span class="s">, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclareToNull"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclareToNull">[docs]</a>    <span class="k">class</span> <span class="nc">DeclareToNull</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroBytes</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">tonull</span><span class="se">\&quot;</span><span class="s">, None)&quot;</span>
</div>
    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="BinaryFormatter.DeclarePrefixed"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.DeclarePrefixed">[docs]</a>    <span class="k">class</span> <span class="nc">DeclarePrefixed</span><span class="p">(</span><span class="n">Declare</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">avroType</span> <span class="o">=</span> <span class="n">AvroBytes</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">prefixed</span><span class="se">\&quot;</span><span class="s">, None)&quot;</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="BinaryFormatter.formatToDeclare"><a class="viewcode-back" href="../../titus.html#titus.pfaast.BinaryFormatter.formatToDeclare">[docs]</a>    <span class="k">def</span> <span class="nf">formatToDeclare</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatPad</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>             <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclarePad</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatBoolean</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>       <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareBoolean</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatByte</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>          <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareByte</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatUnsignedByte</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>  <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareByte</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatShort</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>         <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareShort</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s">&quot;little&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatUnsignedShort</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span> <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareShort</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s">&quot;little&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatInt</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>           <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareInt</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s">&quot;little&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatUnsignedInt</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>   <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareInt</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s">&quot;little&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatLong</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>          <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareLong</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s">&quot;little&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatUnsignedLong</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>  <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareLong</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s">&quot;little&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatFloat</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>         <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareFloat</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s">&quot;little&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatDouble</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>        <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareDouble</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s">&quot;little&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatRawSize</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>       <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareRawSize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatRawSize</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatToNull</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>        <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareToNull</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatPrefixed</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>      <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclarePrefixed</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatRaw</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">DeclareRaw</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;cannot read from unsized </span><span class="se">\&quot;</span><span class="s">raw</span><span class="se">\&quot;</span><span class="s"> in binary formatter&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;unrecognized formatter </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> found in unpack&#39;s </span><span class="se">\&quot;</span><span class="s">format</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Pack"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pack">[docs]</a><span class="k">class</span> <span class="nc">Pack</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exprs</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">exprs</span><span class="se">\&quot;</span><span class="s"> must be a list of (string, Expression) tuples&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pack</span><span class="se">\&quot;</span><span class="s"> must contain at least one format-expression mapping&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Pack.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pack.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Pack</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pack.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pack.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Pack</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pack.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pack.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">exprsDeclareRes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">:</span>
            <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>

            <span class="n">declare</span> <span class="o">=</span> <span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatToDeclare</span><span class="p">(</span><span class="n">exprRes</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">declare</span><span class="o">.</span><span class="n">avroType</span><span class="o">.</span><span class="n">accepts</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">retType</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pack</span><span class="se">\&quot;</span><span class="s"> expression with type {0} cannot be cast to {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="n">exprsDeclareRes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">declare</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroBytes</span><span class="p">(),</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">exprsDeclareRes</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Pack.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pack.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;pack&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;pack&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">f</span><span class="p">:</span> <span class="n">expr</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;pack&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Pack.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Pack.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">exprsDeclareRes</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Unpack"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Unpack">[docs]</a><span class="k">class</span> <span class="nc">Unpack</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">bytes</span><span class="se">\&quot;</span><span class="s"> must be an Expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">format</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">format</span><span class="se">\&quot;</span><span class="s"> must be a list of (string, string) tuples&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thenClause</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thenClause</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">thenClause</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elseClause</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elseClause</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">elseClause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">elseClause</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;unpack&#39;s </span><span class="se">\&quot;</span><span class="s">format</span><span class="se">\&quot;</span><span class="s"> must contain at least one symbol-format mapping&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">then</span><span class="se">\&quot;</span><span class="s"> clause must contain at least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">elseClause</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">else</span><span class="se">\&quot;</span><span class="s"> clause must contain at least one expression&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Unpack.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Unpack.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Unpack</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">)</span> <span class="o">+</span> \
               <span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[])</span>
</div>
<div class="viewcode-block" id="Unpack.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Unpack.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">],</span>
                          <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Unpack.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Unpack.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
        <span class="n">bytesScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">assignmentScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">bytesCtx</span><span class="p">,</span> <span class="n">bytesRes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">bytesScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bytesCtx</span><span class="o">.</span><span class="n">retType</span><span class="p">,</span> <span class="n">AvroBytes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">unpack</span><span class="se">\&quot;</span><span class="s"> expression must be a bytes object&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">bytesCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="n">formatter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">assignmentScope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;symbol </span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> may not be redeclared or shadowed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">validSymbolName</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{0}</span><span class="se">\&quot;</span><span class="s"> is not a valid symbol name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">formatter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BinaryFormatter</span><span class="o">.</span><span class="n">formatToDeclare</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
            <span class="n">assignmentScope</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">formatter</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">avroType</span><span class="p">)</span>

        <span class="n">thenScope</span> <span class="o">=</span> <span class="n">assignmentScope</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">thenResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">thenScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">thenResults</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">elseScope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

            <span class="n">elseResults</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">elseScope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">exprCtx</span><span class="p">,</span> <span class="n">exprRes</span> <span class="ow">in</span> <span class="n">elseResults</span><span class="p">:</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">exprCtx</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span>

            <span class="n">thenType</span> <span class="o">=</span> <span class="n">thenResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span>
            <span class="n">elseType</span> <span class="o">=</span> <span class="n">elseResults</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">retType</span> <span class="o">=</span> <span class="n">LabelData</span><span class="o">.</span><span class="n">broadestType</span><span class="p">([</span><span class="n">thenType</span><span class="p">,</span> <span class="n">elseType</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">IncompatibleTypes</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PFASemanticException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">retType</span><span class="p">,</span> <span class="n">elseTaskResults</span><span class="p">,</span> <span class="n">elseSymbols</span> <span class="o">=</span> <span class="n">retType</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elseResults</span><span class="p">],</span> <span class="n">elseScope</span><span class="o">.</span><span class="n">inThisScope</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retType</span><span class="p">,</span> <span class="n">elseTaskResults</span><span class="p">,</span> <span class="n">elseSymbols</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">(),</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">bytesRes</span><span class="p">,</span> <span class="n">formatter</span><span class="p">,</span> <span class="n">thenScope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thenResults</span><span class="p">],</span> <span class="n">elseSymbols</span><span class="p">,</span> <span class="n">elseTaskResults</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Unpack.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Unpack.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;unpack&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;format&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">s</span><span class="p">:</span> <span class="n">f</span><span class="p">})</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;then&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thenClause</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;else&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elseClause</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;unpack&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Unpack.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Unpack.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">formatter</span><span class="p">,</span> <span class="n">thenSymbols</span><span class="p">,</span> <span class="n">thenClause</span><span class="p">,</span> <span class="n">elseSymbols</span><span class="p">,</span> <span class="n">elseClause</span><span class="p">):</span> <span class="k">pass</span>
        </div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Doc"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Doc">[docs]</a><span class="k">class</span> <span class="nc">Doc</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">comment</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Doc.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Doc.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Doc.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Doc.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;doc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;doc&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Doc.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Doc.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Error"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Error">[docs]</a><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">message</span><span class="se">\&quot;</span><span class="s"> must be a string&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">code</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">code</span><span class="se">\&quot;</span><span class="s"> must be an int or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Error.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Error.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">ExceptionType</span><span class="p">(),</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Error.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Error.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;error&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Error.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Error.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Try"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Try">[docs]</a><span class="k">class</span> <span class="nc">Try</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exprs</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">exprs</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">filter</span><span class="se">\&quot;</span><span class="s"> must be a list of strings or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Try.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Try.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Try</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Try.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Try.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Try</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">],</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Try.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Try.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">]</span>

        <span class="n">exprType</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">retType</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprType</span><span class="p">,</span> <span class="n">ExceptionType</span><span class="p">):</span>
            <span class="n">exprType</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">()</span>
            <span class="n">inferredType</span> <span class="o">=</span> <span class="n">AvroNull</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprType</span><span class="p">,</span> <span class="n">AvroUnion</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">AvroNull</span><span class="p">()</span> <span class="ow">in</span> <span class="n">exprType</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
                <span class="n">inferredType</span> <span class="o">=</span> <span class="n">exprType</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inferredType</span> <span class="o">=</span> <span class="n">AvroUnion</span><span class="p">(</span><span class="n">exprType</span><span class="o">.</span><span class="n">types</span> <span class="o">+</span> <span class="p">[</span><span class="n">AvroNull</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inferredType</span> <span class="o">=</span> <span class="n">AvroUnion</span><span class="p">([</span><span class="n">exprType</span><span class="p">,</span> <span class="n">AvroNull</span><span class="p">()])</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">inferredType</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calls</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]))</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">scope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">exprType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Try.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Try.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;try&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;try&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Try.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Try.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">exprs</span><span class="p">,</span> <span class="n">exprType</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span> <span class="k">pass</span>
</div></div>
<span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Log"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Log">[docs]</a><span class="k">class</span> <span class="nc">Log</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exprs</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pos</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exprs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">exprs</span><span class="se">\&quot;</span><span class="s"> must be a list of Expressions&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PFASyntaxException</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">namespace</span><span class="se">\&quot;</span><span class="s"> must be a string or None&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<div class="viewcode-block" id="Log.collect"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Log.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Log</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Log.replace"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Log.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pf</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Log</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">],</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Log.walk"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Log.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">symbolTable</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">):</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">symbolTable</span><span class="o">.</span><span class="n">newScope</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">functionTable</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">]</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">AvroNull</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(</span><span class="n">titus</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calls</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]))</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">])),</span> <span class="n">scope</span><span class="o">.</span><span class="n">inThisScope</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">engineOptions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Log.jsonNode"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Log.jsonNode">[docs]</a>    <span class="k">def</span> <span class="nf">jsonNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startDict</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s">&quot;log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">jsonNode</span><span class="p">(</span><span class="n">lineNumbers</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&quot;namespace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;log&quot;</span>

    <span class="nd">@titus.util.case</span>
<div class="viewcode-block" id="Log.Context"><a class="viewcode-back" href="../../titus.html#titus.pfaast.Log.Context">[docs]</a>    <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">ExpressionContext</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">calls</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">exprTypes</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span> <span class="k">pass</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Titus 0.7.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Open Data Group.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>
